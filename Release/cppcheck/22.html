
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [<a href="https://github.com/quinoacomputing/quinoa/commit/7b3f598">Quinoa_v0.2-1673-g7b3f598</a>]</title>
    <link rel="stylesheet" href="style.css">
    <style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script language="javascript">
      function getStyle(el,styleProp) {
        if (el.currentStyle)
          var y = el.currentStyle[styleProp];
        else if (window.getComputedStyle)
          var y = document.defaultView.getComputedStyle(el,null).getPropertyValue(styleProp);
        return y;
      }
      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;
        if (el.style.display == "block") {
          el.style.display = "none";
          mark.innerHTML = "[+]";
        } else {
          el.style.display = "block";
          mark.innerHTML = "[-]";
        }
      }
      function init_expandables() {
        var elts = document.getElementsByClassName("expandable");
        for (var i = 0; i < elts.length; i++) {
          var el = elts[i];
          var clickable = el.getElementsByTagName("span")[0];
          var marker = clickable.getElementsByClassName("marker")[0];
          var content = el.getElementsByClassName("content")[0];
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.onclick = toggle;
        }
      }
      function set_class_display(c, st) {
        var elements = document.querySelectorAll('.' + c),
            len = elements.length;
        for (i = 0; i < len; i++) {
            elements[i].style.display = st;
        }
      }
      function toggle_class_visibility(id) {
        var box = document.getElementById(id);
        set_class_display(id, box.checked ? '' : 'none');
      }
    </script>
  </head>
  <body onload="init_expandables()">
      <div id="header">
        <h1>Cppcheck report - [<a href="https://github.com/quinoacomputing/quinoa/commit/7b3f598">Quinoa_v0.2-1673-g7b3f598</a>]: /tmp/TeamCity-12/work/821a9fd6f64749d9/src/Inciter/AMR/refinement.h </h1>
      </div>
      <div id="menu" dir="rtl">
       <p id="filename"><a href="index.html">Defects:</a> refinement.h</p>
<a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a><a href='22.html#line-55'> assertWithSideEffect 55</a>
      </div>
      <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cp">#ifndef AMR_refinement_h</span>
<a name="line-2"></a><span class="cp">#define AMR_refinement_h</span>
<a name="line-3"></a>
<a name="line-4"></a><span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<a name="line-5"></a>
<a name="line-6"></a><span class="cp">#include</span> <span class="cpf">&quot;Macro.h&quot;</span><span class="cp"></span>
<a name="line-7"></a><span class="cp">#include</span> <span class="cpf">&quot;tet_store.h&quot;</span><span class="cp"></span>
<a name="line-8"></a><span class="cp">#include</span> <span class="cpf">&quot;node_connectivity.h&quot;</span><span class="cp"></span>
<a name="line-9"></a>
<a name="line-10"></a><span class="c1">// TODO: make this have a base class to support multiple generator schemes</span>
<a name="line-11"></a><span class="c1">// using the policy design pattern</span>
<a name="line-12"></a>
<a name="line-13"></a><span class="cp">#if defined(STRICT_GNUC)</span>
<a name="line-14"></a>  <span class="cp">#pragma GCC diagnostic push</span>
<a name="line-15"></a>  <span class="cp">#pragma GCC diagnostic ignored &quot;-Wunused-but-set-variable&quot;</span>
<a name="line-16"></a><span class="cp">#endif</span>
<a name="line-17"></a>
<a name="line-18"></a><span class="n">namespace</span> <span class="n">AMR</span> <span class="p">{</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class="n">class</span> <span class="n">refinement_t</span> <span class="p">{</span>
<a name="line-21"></a>        <span class="nl">private</span><span class="p">:</span>
<a name="line-22"></a>
<a name="line-23"></a>            <span class="k">const</span> <span class="kt">size_t</span> <span class="n">DEFAULT_REFINEMENT_LEVEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//TODO: Is this in the right place?</span>
<a name="line-24"></a>            <span class="k">const</span> <span class="kt">size_t</span> <span class="n">MIN_REFINEMENT_LEVEL</span> <span class="o">=</span> <span class="n">DEFAULT_REFINEMENT_LEVEL</span><span class="p">;</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class="nl">public</span><span class="p">:</span>
<a name="line-27"></a>
<a name="line-28"></a>            <span class="k">const</span> <span class="kt">size_t</span> <span class="n">MAX_REFINEMENT_LEVEL</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<a name="line-29"></a>
<a name="line-30"></a>            <span class="c1">// TODO: Document this</span>
<a name="line-31"></a>            <span class="n">child_id_list_t</span> <span class="nf">generate_child_ids</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">MAX_CHILDREN</span><span class="p">)</span>
<a name="line-32"></a>            <span class="p">{</span>
<a name="line-33"></a>                <span class="c1">//return morton_id_generator_t::get_children_ids(parent_id);</span>
<a name="line-34"></a>                <span class="k">return</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_child_ids</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<a name="line-35"></a>            <span class="p">}</span>
<a name="line-36"></a>
<a name="line-37"></a>            <span class="cm">/**</span>
<a name="line-38"></a><span class="cm">             * @brief function to detect when an invalid refinement is</span>
<a name="line-39"></a><span class="cm">             * invoked</span>
<a name="line-40"></a><span class="cm">             *</span>
<a name="line-41"></a><span class="cm">             * @param tet_id Id the of the tet which will be refined</span>
<a name="line-42"></a><span class="cm">             *</span>
<a name="line-43"></a><span class="cm">             * @return A bool stating if the tet can be validly refined</span>
<a name="line-44"></a><span class="cm">             */</span>
<a name="line-45"></a>            <span class="kt">bool</span> <span class="nf">check_allowed_refinement</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-46"></a>            <span class="p">{</span>
<a name="line-47"></a>                <span class="n">Refinement_State</span><span class="o">&amp;</span> <span class="n">master_element</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-48"></a>
<a name="line-49"></a>                <span class="c1">// These asserts mean we never actually try refine a 1:2 or 1:4</span>
<a name="line-50"></a>                <span class="n">assert</span><span class="p">(</span> <span class="n">master_element</span><span class="p">.</span><span class="n">refinement_case</span> <span class="o">!=</span>
<a name="line-51"></a>                        <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_two</span><span class="p">);</span>
<a name="line-52"></a>                <span class="n">assert</span><span class="p">(</span> <span class="n">master_element</span><span class="p">.</span><span class="n">refinement_case</span> <span class="o">!=</span>
<a name="line-53"></a>                        <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_four</span><span class="p">);</span>
<a name="line-54"></a>
<a name="line-55"></a><span class="hll">                <span class="n">assert</span><span class="p">(</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">tet_id</span><span class="p">)</span> <span class="p">);</span><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div><div class='verbose expandable'><span class='error2'>&lt;--- Assert statement calls a function which may have desired side effects: 'is_active'. <span class='marker'>[+]</span></span><div class='content'>Non-pure function: &apos;is_active&apos; is called inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div>
</span><a name="line-56"></a>
<a name="line-57"></a>                <span class="c1">// Check this won&#39;t take us past the max refinement level</span>
<a name="line-58"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">master_element</span><span class="p">.</span><span class="n">refinement_level</span> <span class="o">&gt;=</span> <span class="n">MAX_REFINEMENT_LEVEL</span><span class="p">)</span>
<a name="line-59"></a>                <span class="p">{</span>
<a name="line-60"></a>                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<a name="line-61"></a>                <span class="p">}</span>
<a name="line-62"></a>
<a name="line-63"></a>                <span class="c1">// If we got here, we didn&#39;t detect anything which tells us not</span>
<a name="line-64"></a>                <span class="c1">// to refine</span>
<a name="line-65"></a>                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<a name="line-66"></a>            <span class="p">}</span>
<a name="line-67"></a>
<a name="line-68"></a>            <span class="cm">/**</span>
<a name="line-69"></a><span class="cm">             * @brief Method which takes a tet id, and deduces the other</span>
<a name="line-70"></a><span class="cm">             * parameters needed to perform a 1:2</span>
<a name="line-71"></a><span class="cm">             *</span>
<a name="line-72"></a><span class="cm">             * @param tet_id The id to refine 1:2</span>
<a name="line-73"></a><span class="cm">             */</span>
<a name="line-74"></a>            <span class="kt">void</span> <span class="nf">refine_one_to_two</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">node_connectivity_t</span><span class="o">&amp;</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-75"></a>            <span class="p">{</span>
<a name="line-76"></a>                <span class="n">edge_list_t</span> <span class="n">edge_list</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-77"></a>                <span class="n">node_pair_t</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">find_single_refinement_nodes</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">edge_list</span><span class="p">);</span>
<a name="line-78"></a>                <span class="n">refine_one_to_two</span><span class="p">(</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="line-79"></a>            <span class="p">}</span>
<a name="line-80"></a>
<a name="line-81"></a>            <span class="cm">/**</span>
<a name="line-82"></a><span class="cm">             * @brief Method which takes a tet id, and transforms arguments</span>
<a name="line-83"></a><span class="cm">             * into the form needed for the main 1:2 refinement method</span>
<a name="line-84"></a><span class="cm">             *</span>
<a name="line-85"></a><span class="cm">             * @param tet_id The id to refine 1:2</span>
<a name="line-86"></a><span class="cm">             */</span>
<a name="line-87"></a><span class="cm">/*</span>
<a name="line-88"></a><span class="cm">            void refine_one_to_two(</span>
<a name="line-89"></a><span class="cm">                    size_t tet_id,</span>
<a name="line-90"></a><span class="cm">                    std::string edge_key</span>
<a name="line-91"></a><span class="cm">            )</span>
<a name="line-92"></a><span class="cm">            {</span>
<a name="line-93"></a><span class="cm">                std::vector&lt;std::string&gt; nodes = util::split(edge_key,KEY_DELIM);</span>
<a name="line-94"></a><span class="cm">                size_t edge_node_A_id =  std::stoul (nodes[0],nullptr,0);</span>
<a name="line-95"></a><span class="cm">                size_t edge_node_B_id =  std::stoul (nodes[1],nullptr,0);</span>
<a name="line-96"></a><span class="cm">                refine_one_to_two( tet_id, edge_node_A_id, edge_node_B_id);</span>
<a name="line-97"></a><span class="cm">            }</span>
<a name="line-98"></a><span class="cm">*/</span>
<a name="line-99"></a>            <span class="cm">/**</span>
<a name="line-100"></a><span class="cm">             * @brief Refine a given tet id into 2 children.</span>
<a name="line-101"></a><span class="cm">             * NOTE: Does not do any validity checking (currently?)</span>
<a name="line-102"></a><span class="cm">             *</span>
<a name="line-103"></a><span class="cm">             * @param tet_id Id of tet to refine</span>
<a name="line-104"></a><span class="cm">             * @param edge_node_A_id The first node of id of the edge which</span>
<a name="line-105"></a><span class="cm">             * will be split</span>
<a name="line-106"></a><span class="cm">             * @param edge_node_B_id The second node of id of the</span>
<a name="line-107"></a><span class="cm">             * edge which will be split</span>
<a name="line-108"></a><span class="cm">             */</span>
<a name="line-109"></a>            <span class="kt">void</span> <span class="nf">refine_one_to_two</span><span class="p">(</span>
<a name="line-110"></a>                    <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-111"></a>                    <span class="n">node_connectivity_t</span><span class="o">&amp;</span> <span class="n">node_connectivity</span><span class="p">,</span>
<a name="line-112"></a>                    <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">,</span>
<a name="line-113"></a>                    <span class="kt">size_t</span> <span class="n">edge_node_A_id</span><span class="p">,</span>
<a name="line-114"></a>                    <span class="kt">size_t</span> <span class="n">edge_node_B_id</span>
<a name="line-115"></a>            <span class="p">)</span>
<a name="line-116"></a>            <span class="p">{</span>
<a name="line-117"></a>
<a name="line-118"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;refine_one_to_two&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-119"></a>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_allowed_refinement</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="line-120"></a>
<a name="line-121"></a>                <span class="n">tet_t</span> <span class="n">original_tet</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-122"></a>
<a name="line-123"></a>                <span class="c1">//coordinate_t original_tet_c = node_connectivity-&gt;id_to_coordinate(id);</span>
<a name="line-124"></a>
<a name="line-125"></a>                <span class="kt">size_t</span> <span class="n">new_node_id</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span> <span class="n">edge_node_A_id</span><span class="p">,</span> <span class="n">edge_node_B_id</span> <span class="p">);</span>
<a name="line-126"></a>
<a name="line-127"></a>                <span class="c1">/// Split existing tet into two new tets</span>
<a name="line-128"></a>
<a name="line-129"></a>                <span class="c1">// The two new tets will be the same, but for each an edge will</span>
<a name="line-130"></a>                <span class="c1">// be cut, losing an edge  replaced by E</span>
<a name="line-131"></a>
<a name="line-132"></a>                <span class="n">tet_t</span> <span class="n">new_tet1</span><span class="p">;</span>
<a name="line-133"></a>                <span class="n">tet_t</span> <span class="n">new_tet2</span><span class="p">;</span>
<a name="line-134"></a>
<a name="line-135"></a>                <span class="c1">// Create a new tet that is based on the original</span>
<a name="line-136"></a>                <span class="n">copy_tet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tet1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">original_tet</span><span class="p">);</span>
<a name="line-137"></a>
<a name="line-138"></a>                <span class="c1">// Replace all node ids in tet that were pointing to A with new_node_id</span>
<a name="line-139"></a>                <span class="n">replace_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tet1</span><span class="p">,</span> <span class="n">edge_node_A_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">);</span>
<a name="line-140"></a>
<a name="line-141"></a>                <span class="c1">// Create a new tet that is based on the original</span>
<a name="line-142"></a>                <span class="n">copy_tet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tet2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">original_tet</span><span class="p">);</span>
<a name="line-143"></a>
<a name="line-144"></a>                <span class="c1">// Replace all node ids in tet that were pointing to B with new_node_id</span>
<a name="line-145"></a>                <span class="n">replace_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tet2</span><span class="p">,</span> <span class="n">edge_node_B_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">);</span>
<a name="line-146"></a>
<a name="line-147"></a>                <span class="c1">// Now, update the edge list</span>
<a name="line-148"></a>
<a name="line-149"></a>                <span class="c1">// Generate edges for split</span>
<a name="line-150"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_node_A_id</span><span class="p">,</span> <span class="n">edge_node_B_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">,</span>
<a name="line-151"></a>                        <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-152"></a>
<a name="line-153"></a>                <span class="n">child_id_list_t</span> <span class="n">child_list</span> <span class="o">=</span> <span class="n">generate_child_ids</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a name="line-154"></a>
<a name="line-155"></a>                <span class="kt">size_t</span> <span class="n">first_child_id</span> <span class="o">=</span> <span class="n">child_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="line-156"></a>                <span class="kt">size_t</span> <span class="n">second_child_id</span> <span class="o">=</span> <span class="n">child_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="line-157"></a>
<a name="line-158"></a>                <span class="c1">// Add the two new tets to the system</span>
<a name="line-159"></a>                <span class="kt">size_t</span> <span class="n">new_tet_id</span> <span class="o">=</span> <span class="n">first_child_id</span><span class="p">;</span>
<a name="line-160"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
<a name="line-161"></a>                        <span class="n">first_child_id</span><span class="p">,</span>
<a name="line-162"></a>                        <span class="n">new_tet1</span><span class="p">,</span>
<a name="line-163"></a>                        <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_two</span><span class="p">,</span>
<a name="line-164"></a>                        <span class="n">tet_id</span>
<a name="line-165"></a>                <span class="p">);</span>
<a name="line-166"></a>
<a name="line-167"></a>                <span class="c1">//size_t new_tet_id2 = second_child_id;</span>
<a name="line-168"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
<a name="line-169"></a>                        <span class="n">second_child_id</span><span class="p">,</span>
<a name="line-170"></a>                        <span class="n">new_tet2</span><span class="p">,</span>
<a name="line-171"></a>                        <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_two</span><span class="p">,</span>
<a name="line-172"></a>                        <span class="n">tet_id</span>
<a name="line-173"></a>                <span class="p">);</span>
<a name="line-174"></a>
<a name="line-175"></a>                <span class="c1">//trace_out &lt;&lt; &quot;1:2 DOING REFINE OF &quot; &lt;&lt; tet_id &lt;&lt; &quot;. Adding &quot; &lt;&lt; child_list[0] &lt;&lt; &quot; and &quot; &lt;&lt; child_list[1] &lt;&lt; std::endl;</span>
<a name="line-176"></a>
<a name="line-177"></a>                <span class="c1">// This call is only needed to add a single edge, from the new</span>
<a name="line-178"></a>                <span class="c1">// node to the node on the normal to that face, but avoids</span>
<a name="line-179"></a>                <span class="c1">// directly calculating which nodes that is</span>
<a name="line-180"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edges</span><span class="p">(</span><span class="n">new_tet_id</span><span class="p">);</span>
<a name="line-181"></a>
<a name="line-182"></a>                <span class="c1">// Currently we lock one per tet, around the split node. We</span>
<a name="line-183"></a>                <span class="c1">// also need to lock the two &quot;arms&quot; which come out from it</span>
<a name="line-184"></a>                <span class="c1">//lock_edges_from_node(new_tet_id, new_node_id, Edge_Lock_Case::intermediate);</span>
<a name="line-185"></a>                <span class="c1">//lock_edges_from_node(new_tet_id2, new_node_id, Edge_Lock_Case::intermediate);</span>
<a name="line-186"></a>
<a name="line-187"></a>                <span class="c1">// Deactivate parent tet?</span>
<a name="line-188"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">deactivate</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-189"></a>                <span class="c1">//lock_edges_from_node(new_node_id, Edge_Lock_Case::intermediate);</span>
<a name="line-190"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_node_id</span><span class="p">);</span>
<a name="line-191"></a>            <span class="p">}</span>
<a name="line-192"></a>
<a name="line-193"></a>            <span class="cm">/**</span>
<a name="line-194"></a><span class="cm">             * @brief Method which takes a tet id, and deduces the other</span>
<a name="line-195"></a><span class="cm">             * parameters needed to perform a 1:4</span>
<a name="line-196"></a><span class="cm">             *</span>
<a name="line-197"></a><span class="cm">             * @param tet_id The id to refine 1:4</span>
<a name="line-198"></a><span class="cm">            */</span>
<a name="line-199"></a>            <span class="kt">void</span> <span class="nf">refine_one_to_four</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> 
<a name="line-200"></a>                    <span class="n">node_connectivity_t</span><span class="o">&amp;</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-201"></a>            <span class="p">{</span>
<a name="line-202"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;do refine 1:4 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-203"></a>                <span class="c1">//bool face_refine = false;</span>
<a name="line-204"></a>                <span class="kt">size_t</span> <span class="n">face_refine_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// FIXME: Does this need a better default</span>
<a name="line-205"></a>                <span class="n">face_list_t</span> <span class="n">face_list</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_face_lists</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-206"></a>
<a name="line-207"></a>                <span class="c1">// Iterate over each face</span>
<a name="line-208"></a>                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">face</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">face</span> <span class="o">&lt;</span> <span class="n">NUM_TET_FACES</span><span class="p">;</span> <span class="n">face</span><span class="o">++</span><span class="p">)</span>
<a name="line-209"></a>                <span class="p">{</span>
<a name="line-210"></a>                    <span class="kt">int</span> <span class="n">num_face_refine_edges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-211"></a>
<a name="line-212"></a>                    <span class="n">face_ids_t</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">face_list</span><span class="p">[</span><span class="n">face</span><span class="p">];</span>
<a name="line-213"></a>                    <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face ids &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-214"></a>                        <span class="n">face_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-215"></a>                        <span class="n">face_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-216"></a>                        <span class="n">face_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-217"></a>                        <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-218"></a>
<a name="line-219"></a>                    <span class="n">edge_list_t</span> <span class="n">face_edge_list</span> <span class="o">=</span> <span class="n">AMR</span><span class="o">::</span><span class="n">edge_store_t</span><span class="o">::</span><span class="n">generate_keys_from_face_ids</span><span class="p">(</span><span class="n">face_ids</span><span class="p">);</span>
<a name="line-220"></a>                    <span class="c1">// For this face list, see which ones need refining</span>
<a name="line-221"></a>                    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_FACE_NODES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-222"></a>                    <span class="p">{</span>
<a name="line-223"></a>                        <span class="n">edge_t</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">face_edge_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-224"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">).</span><span class="n">needs_refining</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
<a name="line-225"></a>                        <span class="p">{</span>
<a name="line-226"></a>                            <span class="n">num_face_refine_edges</span><span class="o">++</span><span class="p">;</span>
<a name="line-227"></a>                        <span class="p">}</span>
<a name="line-228"></a>
<a name="line-229"></a>                        <span class="c1">// Check for locked edges</span>
<a name="line-230"></a>                            <span class="c1">// This case only cares about faces with no locks</span>
<a name="line-231"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">lock_case</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">)</span>
<a name="line-232"></a>                        <span class="p">{</span>
<a name="line-233"></a>                            <span class="c1">// Abort this face</span>
<a name="line-234"></a>                            <span class="n">num_face_refine_edges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-235"></a>                            <span class="k">continue</span><span class="p">;</span>
<a name="line-236"></a>                        <span class="p">}</span>
<a name="line-237"></a>                    <span class="p">}</span>
<a name="line-238"></a>                    <span class="k">if</span> <span class="p">(</span><span class="n">num_face_refine_edges</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
<a name="line-239"></a>                    <span class="p">{</span>
<a name="line-240"></a>                        <span class="n">assert</span><span class="p">(</span><span class="n">num_face_refine_edges</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span>
<a name="line-241"></a>                        <span class="c1">//face_refine = true;</span>
<a name="line-242"></a>                        <span class="n">face_refine_id</span> <span class="o">=</span> <span class="n">face</span><span class="p">;</span>
<a name="line-243"></a>                        <span class="k">break</span><span class="p">;</span>
<a name="line-244"></a>                    <span class="p">}</span>
<a name="line-245"></a>                <span class="p">}</span>
<a name="line-246"></a>
<a name="line-247"></a>                <span class="n">tet_t</span> <span class="n">tet</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-248"></a>                <span class="kt">size_t</span> <span class="n">opposite_offset</span> <span class="o">=</span> <span class="n">AMR</span><span class="o">::</span><span class="n">node_connectivity_t</span><span class="o">::</span><span class="n">face_list_opposite</span><span class="p">(</span><span class="n">face_list</span><span class="p">,</span> <span class="n">face_refine_id</span><span class="p">);</span>
<a name="line-249"></a>                <span class="kt">size_t</span> <span class="n">opposite_id</span> <span class="o">=</span> <span class="n">tet</span><span class="p">[</span><span class="n">opposite_offset</span><span class="p">];</span>
<a name="line-250"></a>
<a name="line-251"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1:4 tet mark id &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tet_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-252"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;opposite offset &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">opposite_offset</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-253"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;opposite id &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">opposite_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-254"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face refine id &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">face_refine_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-255"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face list 0 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">face_list</span><span class="p">[</span><span class="n">face_refine_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-256"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face list 1 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">face_list</span><span class="p">[</span><span class="n">face_refine_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-257"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face list 2 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">face_list</span><span class="p">[</span><span class="n">face_refine_id</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-258"></a>
<a name="line-259"></a>                <span class="n">refine_one_to_four</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">,</span> <span class="n">face_list</span><span class="p">[</span><span class="n">face_refine_id</span><span class="p">],</span> <span class="n">opposite_id</span><span class="p">);</span>
<a name="line-260"></a>            <span class="p">}</span>
<a name="line-261"></a>
<a name="line-262"></a>            <span class="cm">/**</span>
<a name="line-263"></a><span class="cm">             * @brief Refine a given tet id into 4 children.</span>
<a name="line-264"></a><span class="cm">             * NOTE: Does not do any validity checking (currently?)</span>
<a name="line-265"></a><span class="cm">             *</span>
<a name="line-266"></a><span class="cm">             * @param tet_id The id of the tet to refine</span>
<a name="line-267"></a><span class="cm">             * @param face_ids The ids which make the face to be split</span>
<a name="line-268"></a><span class="cm">             * @param opposite_id The remaining id which is &quot;opposite&quot; the</span>
<a name="line-269"></a><span class="cm">             * split face</span>
<a name="line-270"></a><span class="cm">             */</span>
<a name="line-271"></a>            <span class="kt">void</span> <span class="nf">refine_one_to_four</span><span class="p">(</span>
<a name="line-272"></a>                    <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-273"></a>                    <span class="n">node_connectivity_t</span><span class="o">&amp;</span> <span class="n">node_connectivity</span><span class="p">,</span>
<a name="line-274"></a>                    <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">,</span>
<a name="line-275"></a>                    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">NUM_FACE_NODES</span><span class="o">&gt;</span> <span class="n">face_ids</span><span class="p">,</span>
<a name="line-276"></a>                    <span class="kt">size_t</span> <span class="n">opposite_id</span>
<a name="line-277"></a>            <span class="p">)</span>
<a name="line-278"></a>            <span class="p">{</span>
<a name="line-279"></a>
<a name="line-280"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;refine_one_to_four&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-281"></a>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_allowed_refinement</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="line-282"></a>
<a name="line-283"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Refining tet_id &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tet_id</span> <span class="o">&lt;&lt;</span>
<a name="line-284"></a>                    <span class="s">&quot; 1:4 opposite edge &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">opposite_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-285"></a>
<a name="line-286"></a>                <span class="n">tet_t</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-287"></a>                <span class="n">trace_out</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;Tet has nodes &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-288"></a>                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-289"></a>                    <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-290"></a>                    <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-291"></a>                    <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-292"></a>                    <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-293"></a>
<a name="line-294"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;face_ids &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-295"></a>                    <span class="n">face_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-296"></a>                    <span class="n">face_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-297"></a>                    <span class="n">face_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-298"></a>                    <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-299"></a>
<a name="line-300"></a>                <span class="kt">size_t</span> <span class="n">A</span> <span class="o">=</span> <span class="n">face_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="line-301"></a>                <span class="kt">size_t</span> <span class="n">B</span> <span class="o">=</span> <span class="n">face_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="line-302"></a>                <span class="kt">size_t</span> <span class="n">C</span> <span class="o">=</span> <span class="n">face_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="line-303"></a>                <span class="kt">size_t</span> <span class="n">D</span> <span class="o">=</span> <span class="n">opposite_id</span><span class="p">;</span>
<a name="line-304"></a>
<a name="line-305"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span>
<a name="line-306"></a>                    <span class="s">&quot; A &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">A</span> <span class="o">&lt;&lt;</span>
<a name="line-307"></a>                    <span class="s">&quot; B &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">B</span> <span class="o">&lt;&lt;</span>
<a name="line-308"></a>                    <span class="s">&quot; C &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span>
<a name="line-309"></a>                    <span class="s">&quot; D &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">D</span> <span class="o">&lt;&lt;</span>
<a name="line-310"></a>                    <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-311"></a>
<a name="line-312"></a>                <span class="c1">// Make new nodes</span>
<a name="line-313"></a>                <span class="c1">//coordinate_t AB_mid = node_connectivity-&gt;find_mid_point(A, B);</span>
<a name="line-314"></a>                <span class="kt">size_t</span> <span class="n">AB</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
<a name="line-315"></a>
<a name="line-316"></a>                <span class="c1">//coordinate_t AC_mid = node_connectivity-&gt;find_mid_point(A, C);</span>
<a name="line-317"></a>                <span class="kt">size_t</span> <span class="n">AC</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">);</span>
<a name="line-318"></a>
<a name="line-319"></a>                <span class="c1">//coordinate_t BC_mid = node_connectivity-&gt;find_mid_point(B, C);</span>
<a name="line-320"></a>                <span class="kt">size_t</span> <span class="n">BC</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">);</span>
<a name="line-321"></a>
<a name="line-322"></a>                <span class="c1">// Use nodes to update edges</span>
<a name="line-323"></a>                <span class="c1">// All added edges will be locked due to containing intermediate points</span>
<a name="line-324"></a>                <span class="c1">// Split Outer face  edges</span>
<a name="line-325"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-326"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-327"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-328"></a>
<a name="line-329"></a>                <span class="c1">// Connect D to intermediate points</span>
<a name="line-330"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-331"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-332"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-333"></a>                <span class="c1">// Connect inner edges</span>
<a name="line-334"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-335"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-336"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">);</span>
<a name="line-337"></a>
<a name="line-338"></a>                <span class="c1">// Make new Tets</span>
<a name="line-339"></a>                <span class="c1">//  This is just the node opposite the face plus each pair</span>
<a name="line-340"></a>                <span class="c1">//  of the news nodes, and the old corner</span>
<a name="line-341"></a>                <span class="c1">//  FIXME: How to find that near corner programatically?</span>
<a name="line-342"></a>
<a name="line-343"></a>                <span class="c1">// Hard coded solution</span>
<a name="line-344"></a>                <span class="c1">// A AC AB D</span>
<a name="line-345"></a>                <span class="c1">// AC AB BC D</span>
<a name="line-346"></a>                <span class="c1">// AC BC C D</span>
<a name="line-347"></a>                <span class="c1">// AB B BC D</span>
<a name="line-348"></a>
<a name="line-349"></a>                <span class="kt">size_t</span> <span class="n">num_children</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<a name="line-350"></a>                <span class="n">child_id_list_t</span> <span class="n">child</span> <span class="o">=</span> <span class="n">generate_child_ids</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">,</span> <span class="n">num_children</span><span class="p">);</span>
<a name="line-351"></a>
<a name="line-352"></a>                <span class="c1">// Outsides</span>
<a name="line-353"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">,</span>  <span class="n">AB</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_four</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-354"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">AC</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span>  <span class="n">D</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_four</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-355"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">AB</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span>  <span class="n">BC</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_four</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-356"></a>
<a name="line-357"></a>                <span class="c1">// Center</span>
<a name="line-358"></a>                <span class="kt">size_t</span> <span class="n">center_id</span> <span class="o">=</span> <span class="n">child</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// 1 to preserve Jacobian order</span>
<a name="line-359"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">center_id</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_four</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-360"></a>
<a name="line-361"></a>
<a name="line-362"></a>                <span class="c1">// TODO: replace this with a more concise way to lock the correct edges</span>
<a name="line-363"></a>
<a name="line-364"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add_center</span><span class="p">(</span><span class="n">center_id</span><span class="p">);</span>
<a name="line-365"></a>                <span class="cm">/*</span>
<a name="line-366"></a><span class="cm">                lock_edges_from_node(child[0], AB, Edge_Lock_Case::intermediate);</span>
<a name="line-367"></a><span class="cm">                lock_edges_from_node(child[0], AC, Edge_Lock_Case::intermediate);</span>
<a name="line-368"></a><span class="cm">                lock_edges_from_node(child[2], AC, Edge_Lock_Case::intermediate);</span>
<a name="line-369"></a><span class="cm">                lock_edges_from_node(child[2], BC, Edge_Lock_Case::intermediate);</span>
<a name="line-370"></a><span class="cm">                lock_edges_from_node(child[3], AB, Edge_Lock_Case::intermediate);</span>
<a name="line-371"></a><span class="cm">                lock_edges_from_node(child[3], BC, Edge_Lock_Case::intermediate);</span>
<a name="line-372"></a><span class="cm">                lock_edges_from_node(center_id, AC, Edge_Lock_Case::intermediate);</span>
<a name="line-373"></a><span class="cm">                lock_edges_from_node(center_id, AB, Edge_Lock_Case::intermediate);</span>
<a name="line-374"></a><span class="cm">                lock_edges_from_node(center_id, BC, Edge_Lock_Case::intermediate);</span>
<a name="line-375"></a><span class="cm">                */</span>
<a name="line-376"></a>
<a name="line-377"></a>
<a name="line-378"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">deactivate</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-379"></a>
<a name="line-380"></a>                <span class="c1">//trace_out &lt;&lt; &quot;1:4 DOING REFINE OF &quot; &lt;&lt; tet_id &lt;&lt; &quot;. Adding &quot;</span>
<a name="line-381"></a>                    <span class="c1">// &lt;&lt; child[0] &lt;&lt; &quot;, &quot;</span>
<a name="line-382"></a>                    <span class="c1">// &lt;&lt; child[1] &lt;&lt; &quot;, &quot;</span>
<a name="line-383"></a>                    <span class="c1">// &lt;&lt; child[2] &lt;&lt; &quot;, &quot;</span>
<a name="line-384"></a>                    <span class="c1">// &lt;&lt; child[3]</span>
<a name="line-385"></a>                    <span class="c1">// &lt;&lt; std::endl;</span>
<a name="line-386"></a>
<a name="line-387"></a>                <span class="cm">/*</span>
<a name="line-388"></a><span class="cm">                lock_edges_from_node(AB, Edge_Lock_Case::intermediate);</span>
<a name="line-389"></a><span class="cm">                lock_edges_from_node(AC, Edge_Lock_Case::intermediate);</span>
<a name="line-390"></a><span class="cm">                lock_edges_from_node(BC, Edge_Lock_Case::intermediate);</span>
<a name="line-391"></a><span class="cm">                */</span>
<a name="line-392"></a>
<a name="line-393"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">AB</span><span class="p">);</span>
<a name="line-394"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">AC</span><span class="p">);</span>
<a name="line-395"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BC</span><span class="p">);</span>
<a name="line-396"></a>
<a name="line-397"></a>            <span class="p">}</span>
<a name="line-398"></a>
<a name="line-399"></a>            <span class="cm">/**</span>
<a name="line-400"></a><span class="cm">             * @brief Refine a given tet id into 8 children.</span>
<a name="line-401"></a><span class="cm">             * NOTE: Does not do any validity checking (currently?)</span>
<a name="line-402"></a><span class="cm">             *</span>
<a name="line-403"></a><span class="cm">             * @param tet_id Id of tet to refine</span>
<a name="line-404"></a><span class="cm">             */</span>
<a name="line-405"></a>            <span class="kt">void</span> <span class="nf">refine_one_to_eight</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-406"></a>                    <span class="n">node_connectivity_t</span><span class="o">&amp;</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-407"></a>            <span class="p">{</span>
<a name="line-408"></a>
<a name="line-409"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;refine_one_to_eight&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-410"></a>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_allowed_refinement</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
<a name="line-411"></a>
<a name="line-412"></a>                <span class="c1">// Split every edge into two</span>
<a name="line-413"></a>                <span class="c1">// Makes 4 tets out of the old corners and 3 near mid-points</span>
<a name="line-414"></a>                <span class="c1">// Make 4 out of the midpoints</span>
<a name="line-415"></a>
<a name="line-416"></a>                <span class="c1">// For Tet {ABCD} need to know all (non-repeating) node pairs</span>
<a name="line-417"></a>                <span class="c1">// {AB} {AC} {AD} {BC} {BD} {CD}</span>
<a name="line-418"></a>                <span class="c1">// This can either be hard coded, or generated with a 2d loop</span>
<a name="line-419"></a>                <span class="c1">// The loop would just be i=0..4, j=i..4</span>
<a name="line-420"></a>                <span class="c1">//</span>
<a name="line-421"></a>
<a name="line-422"></a>
<a name="line-423"></a>                <span class="n">tet_t</span> <span class="n">tet</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-424"></a>
<a name="line-425"></a>                <span class="kt">size_t</span> <span class="n">A</span> <span class="o">=</span> <span class="n">tet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="line-426"></a>                <span class="kt">size_t</span> <span class="n">B</span> <span class="o">=</span> <span class="n">tet</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="line-427"></a>                <span class="kt">size_t</span> <span class="n">C</span> <span class="o">=</span> <span class="n">tet</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="line-428"></a>                <span class="kt">size_t</span> <span class="n">D</span> <span class="o">=</span> <span class="n">tet</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="line-429"></a>
<a name="line-430"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; B &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; C &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; D &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">D</span>
<a name="line-431"></a>                    <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-432"></a>
<a name="line-433"></a>                <span class="c1">// Generate pairs of nodes (i.e edges)</span>
<a name="line-434"></a>                <span class="c1">// Hard coding for now, can swap out for loop</span>
<a name="line-435"></a>                <span class="c1">//coordinate_t AB_mid = node_connectivity-&gt;find_mid_point(A,B);</span>
<a name="line-436"></a>                <span class="kt">size_t</span> <span class="n">AB</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
<a name="line-437"></a>
<a name="line-438"></a>                <span class="c1">//coordinate_t AC_mid = node_connectivity-&gt;find_mid_point(A,C);</span>
<a name="line-439"></a>                <span class="kt">size_t</span> <span class="n">AC</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">);</span>
<a name="line-440"></a>
<a name="line-441"></a>                <span class="c1">//coordinate_t AD_mid = node_connectivity-&gt;find_mid_point(A,D);</span>
<a name="line-442"></a>                <span class="kt">size_t</span> <span class="n">AD</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">D</span><span class="p">);</span>
<a name="line-443"></a>
<a name="line-444"></a>                <span class="c1">//coordinate_t BC_mid = node_connectivity-&gt;find_mid_point(B,C);</span>
<a name="line-445"></a>                <span class="kt">size_t</span> <span class="n">BC</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">);</span>
<a name="line-446"></a>
<a name="line-447"></a>                <span class="c1">//coordinate_t BD_mid = node_connectivity-&gt;find_mid_point(B,D);</span>
<a name="line-448"></a>                <span class="kt">size_t</span> <span class="n">BD</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">);</span>
<a name="line-449"></a>
<a name="line-450"></a>                <span class="c1">//coordinate_t CD_mid = node_connectivity-&gt;find_mid_point(C,D);</span>
<a name="line-451"></a>                <span class="kt">size_t</span> <span class="n">CD</span> <span class="o">=</span> <span class="n">node_connectivity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="p">);</span>
<a name="line-452"></a>
<a name="line-453"></a>                <span class="c1">// Update edges</span>
<a name="line-454"></a>
<a name="line-455"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-456"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-457"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-458"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-459"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-460"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-461"></a>
<a name="line-462"></a>
<a name="line-463"></a>                <span class="c1">// Outside edges for face ABC</span>
<a name="line-464"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-465"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-466"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-467"></a>
<a name="line-468"></a>                <span class="c1">// Outside edges for face ACD</span>
<a name="line-469"></a>           	<span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-470"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AD</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-471"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-472"></a>
<a name="line-473"></a>                <span class="c1">// Outside edges for face BCD</span>
<a name="line-474"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">BD</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-475"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">BD</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-476"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">CD</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-477"></a>
<a name="line-478"></a>                <span class="c1">// Outside edges for face ABD</span>
<a name="line-479"></a>                 <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AD</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-480"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-481"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-482"></a>
<a name="line-483"></a>                <span class="c1">// Interior Edges</span>
<a name="line-484"></a>                   <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-485"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">CD</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">unlocked</span><span class="p">);</span>
<a name="line-486"></a>
<a name="line-487"></a>                <span class="c1">// Add the new tets</span>
<a name="line-488"></a>                <span class="c1">//</span>
<a name="line-489"></a>                <span class="c1">// External</span>
<a name="line-490"></a>                <span class="c1">// A AB AC AD - A</span>
<a name="line-491"></a>                <span class="c1">// B BA BC BD - B</span>
<a name="line-492"></a>                <span class="c1">// C CA CB CD - C</span>
<a name="line-493"></a>                <span class="c1">// D DA DB DC - D</span>
<a name="line-494"></a>                <span class="c1">// -</span>
<a name="line-495"></a>                <span class="c1">// Internal (for a face BDC, it&#39;s the intermediat and mid opposite)</span>
<a name="line-496"></a>                <span class="c1">// BC CD DB AC - BDC</span>
<a name="line-497"></a>                <span class="c1">// AB BD AD AC - ABD</span>
<a name="line-498"></a>                <span class="c1">// AB AC BC BD - ABC</span>
<a name="line-499"></a>                <span class="c1">// AC AD CD BD - ACD</span>
<a name="line-500"></a>                <span class="c1">//</span>
<a name="line-501"></a>
<a name="line-502"></a>                <span class="c1">// TODO: This is actually generating IDs not trying to get them</span>
<a name="line-503"></a>                <span class="n">child_id_list_t</span> <span class="n">child</span> <span class="o">=</span> <span class="n">generate_child_ids</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-504"></a>
<a name="line-505"></a>                <span class="c1">// This order should give a positive Jacobian</span>
<a name="line-506"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-507"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">B</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">AB</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-508"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">C</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-509"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">D</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-510"></a>
<a name="line-511"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">BC</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-512"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">AB</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-513"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">AB</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">AC</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-514"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">AC</span><span class="p">,</span> <span class="n">BD</span><span class="p">,</span> <span class="n">CD</span><span class="p">,</span> <span class="n">AD</span><span class="p">,</span> <span class="n">Refinement_Case</span><span class="o">::</span><span class="n">one_to_eight</span><span class="p">,</span> <span class="n">tet_id</span><span class="p">);</span>
<a name="line-515"></a>
<a name="line-516"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">deactivate</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-517"></a>
<a name="line-518"></a>                <span class="c1">//trace_out &lt;&lt; &quot;1:8 DOING REFINE OF &quot; &lt;&lt; tet_id &lt;&lt; &quot;. &quot;</span>
<a name="line-519"></a>                    <span class="c1">// &lt;&lt; child[0] &lt;&lt; &quot;, &quot;</span>
<a name="line-520"></a>                    <span class="c1">// &lt;&lt; child[1] &lt;&lt; &quot;, &quot;</span>
<a name="line-521"></a>                    <span class="c1">// &lt;&lt; child[2] &lt;&lt; &quot;, &quot;</span>
<a name="line-522"></a>                    <span class="c1">// &lt;&lt; child[3] &lt;&lt; &quot;, &quot;</span>
<a name="line-523"></a>                    <span class="c1">// &lt;&lt; child[4] &lt;&lt; &quot;, &quot;</span>
<a name="line-524"></a>                    <span class="c1">// &lt;&lt; child[5] &lt;&lt; &quot;, &quot;</span>
<a name="line-525"></a>                    <span class="c1">// &lt;&lt; child[6] &lt;&lt; &quot;, &quot;</span>
<a name="line-526"></a>                    <span class="c1">// &lt;&lt; child[7]</span>
<a name="line-527"></a>                    <span class="c1">// &lt;&lt; std::endl;</span>
<a name="line-528"></a>
<a name="line-529"></a>            <span class="p">}</span>
<a name="line-530"></a>
<a name="line-531"></a>            <span class="c1">// This is just a simple assignment, but I wanted to abstract it</span>
<a name="line-532"></a>            <span class="c1">// for if we change the underlying type to something which a simple</span>
<a name="line-533"></a>            <span class="c1">// assignment is no longer safe</span>
<a name="line-534"></a>            <span class="cm">/**</span>
<a name="line-535"></a><span class="cm">             * @brief Function to duplicate (deep copy) a tet. Useful for when</span>
<a name="line-536"></a><span class="cm">             * you want to make a tet that&#39;s very similar to an existing one</span>
<a name="line-537"></a><span class="cm">             *</span>
<a name="line-538"></a><span class="cm">             * @param out The tet to store the copy</span>
<a name="line-539"></a><span class="cm">             * @param original The tet to copy the data from</span>
<a name="line-540"></a><span class="cm">             */</span>
<a name="line-541"></a>            <span class="kt">void</span> <span class="nf">copy_tet</span><span class="p">(</span><span class="n">tet_t</span><span class="o">*</span> <span class="n">out</span><span class="p">,</span> <span class="n">tet_t</span><span class="o">*</span> <span class="n">original</span><span class="p">)</span>
<a name="line-542"></a>            <span class="p">{</span>
<a name="line-543"></a>                <span class="c1">// NOTE: This will do a deep copy, so is safer than it may look</span>
<a name="line-544"></a>                <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="o">*</span><span class="n">original</span><span class="p">;</span>
<a name="line-545"></a>            <span class="p">}</span>
<a name="line-546"></a>
<a name="line-547"></a>            <span class="c1">// This is just a std::replace, but may need to be more complicated</span>
<a name="line-548"></a>            <span class="c1">// in the future?</span>
<a name="line-549"></a>            <span class="cm">/**</span>
<a name="line-550"></a><span class="cm">             * @brief function to take an existing list of tet ids and</span>
<a name="line-551"></a><span class="cm">             * replace one. This can be useful for when you want to build very</span>
<a name="line-552"></a><span class="cm">             * similar tets which share nodes</span>
<a name="line-553"></a><span class="cm">             *</span>
<a name="line-554"></a><span class="cm">             * @param tet Tet to perform operation on</span>
<a name="line-555"></a><span class="cm">             * @param remove Element to be replaced</span>
<a name="line-556"></a><span class="cm">             * @param add Element to replace with</span>
<a name="line-557"></a><span class="cm">             */</span>
<a name="line-558"></a>            <span class="kt">void</span> <span class="nf">replace_node</span><span class="p">(</span><span class="n">tet_t</span><span class="o">*</span> <span class="n">tet</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">remove</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">add</span><span class="p">)</span>
<a name="line-559"></a>            <span class="p">{</span>
<a name="line-560"></a>                <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">tet</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">tet</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(),</span> <span class="n">remove</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
<a name="line-561"></a>            <span class="p">}</span>
<a name="line-562"></a>
<a name="line-563"></a>            <span class="cm">/**</span>
<a name="line-564"></a><span class="cm">             * @brief Function to find out slot in the x,y,z data arrays a tet lives</span>
<a name="line-565"></a><span class="cm">             *</span>
<a name="line-566"></a><span class="cm">             * // NOTE: this is _currently_ trivial, but will be nice if we for</span>
<a name="line-567"></a><span class="cm">             * example swap data stores to a map</span>
<a name="line-568"></a><span class="cm">             *</span>
<a name="line-569"></a><span class="cm">             * @param tet tet of the tet to look for</span>
<a name="line-570"></a><span class="cm">             * @param element offset into that tet to look at</span>
<a name="line-571"></a><span class="cm">             *</span>
<a name="line-572"></a><span class="cm">             * @return tet into data arrays the tet lives</span>
<a name="line-573"></a><span class="cm">             */</span>
<a name="line-574"></a>            <span class="c1">// TODO: Move this (or rename?)</span>
<a name="line-575"></a>            <span class="kt">size_t</span> <span class="nf">tet_id_to_node_id</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
<a name="line-576"></a>                <span class="k">return</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">tet</span><span class="p">)[</span><span class="n">element</span><span class="p">];</span>
<a name="line-577"></a>            <span class="p">}</span>
<a name="line-578"></a>
<a name="line-579"></a>            <span class="cm">/**</span>
<a name="line-580"></a><span class="cm">             * @brief Function to find the nodes which make up the</span>
<a name="line-581"></a><span class="cm">             * single (or first?º edge which needs to be refined in an given</span>
<a name="line-582"></a><span class="cm">             * edge_list</span>
<a name="line-583"></a><span class="cm">             *</span>
<a name="line-584"></a><span class="cm">             * @param edge_list The edge list to search for a refinement edge</span>
<a name="line-585"></a><span class="cm">             *</span>
<a name="line-586"></a><span class="cm">             * @return The node pair which represent the edge which needs</span>
<a name="line-587"></a><span class="cm">             * refining</span>
<a name="line-588"></a><span class="cm">             */</span>
<a name="line-589"></a>            <span class="n">node_pair_t</span> <span class="nf">find_single_refinement_nodes</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">edge_list_t</span> <span class="n">edge_list</span><span class="p">)</span>
<a name="line-590"></a>            <span class="p">{</span>
<a name="line-591"></a>                <span class="n">node_pair_t</span> <span class="n">returned_nodes</span><span class="p">;</span>
<a name="line-592"></a>                <span class="kt">bool</span> <span class="n">found_break</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<a name="line-593"></a>                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-594"></a>                <span class="p">{</span>
<a name="line-595"></a>                    <span class="n">edge_t</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">edge_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-596"></a>
<a name="line-597"></a>                    <span class="k">if</span> <span class="p">(</span><span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">).</span><span class="n">needs_refining</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
<a name="line-598"></a>                    <span class="p">{</span>
<a name="line-599"></a>                        <span class="n">returned_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">();</span>
<a name="line-600"></a>                        <span class="n">returned_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">second</span><span class="p">();</span>
<a name="line-601"></a>
<a name="line-602"></a>                        <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1:2 needs to be split on &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-603"></a>                            <span class="n">returned_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; and &quot;</span> <span class="o">&lt;&lt;</span>
<a name="line-604"></a>                            <span class="n">returned_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-605"></a>
<a name="line-606"></a>                        <span class="n">found_break</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<a name="line-607"></a>                        <span class="k">break</span><span class="p">;</span>
<a name="line-608"></a>                    <span class="p">}</span>
<a name="line-609"></a>                <span class="p">}</span>
<a name="line-610"></a>
<a name="line-611"></a>                <span class="n">assert</span><span class="p">(</span><span class="n">found_break</span><span class="p">);</span>
<a name="line-612"></a>
<a name="line-613"></a>                <span class="k">return</span> <span class="n">returned_nodes</span><span class="p">;</span>
<a name="line-614"></a>            <span class="p">}</span>
<a name="line-615"></a>
<a name="line-616"></a>            <span class="kt">void</span> <span class="nf">lock_intermediates</span><span class="p">(</span>
<a name="line-617"></a>                    <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-618"></a>                    <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">intermediate_list</span><span class="p">,</span>
<a name="line-619"></a>                    <span class="n">Edge_Lock_Case</span> <span class="n">lock_case</span>
<a name="line-620"></a>                <span class="p">)</span>
<a name="line-621"></a>            <span class="p">{</span>
<a name="line-622"></a>                <span class="c1">// Loop over all edges</span>
<a name="line-623"></a>                <span class="c1">// If the edge is in the intermediate_list, deal with it</span>
<a name="line-624"></a>                <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">p</span> <span class="p">:</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">edges</span><span class="p">)</span>
<a name="line-625"></a>                <span class="p">{</span>
<a name="line-626"></a>                    <span class="k">auto</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a name="line-627"></a>                    <span class="kt">size_t</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">first</span><span class="p">();</span>
<a name="line-628"></a>                    <span class="kt">size_t</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">second</span><span class="p">();</span>
<a name="line-629"></a>                    <span class="c1">// Can we make this double search cheaper?</span>
<a name="line-630"></a>                    <span class="k">if</span> <span class="p">(</span>
<a name="line-631"></a>                            <span class="p">(</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">k1</span><span class="p">))</span> <span class="o">||</span>
<a name="line-632"></a>                            <span class="p">(</span><span class="n">intermediate_list</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
<a name="line-633"></a>                       <span class="p">)</span>
<a name="line-634"></a>                    <span class="p">{</span>
<a name="line-635"></a>                        <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">lock_case</span> <span class="o">=</span> <span class="n">lock_case</span><span class="p">;</span>
<a name="line-636"></a>                    <span class="p">}</span>
<a name="line-637"></a>                <span class="p">}</span>
<a name="line-638"></a>
<a name="line-639"></a>            <span class="p">}</span>
<a name="line-640"></a>
<a name="line-641"></a>            <span class="c1">// TODO: remove this, it&#39;s horrible and not efficient.</span>
<a name="line-642"></a>            <span class="c1">// WARNING: THIS GOES OVER ALL TETS!!!!</span>
<a name="line-643"></a>            <span class="kt">void</span> <span class="nf">lock_edges_from_node</span><span class="p">(</span>
<a name="line-644"></a>                    <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-645"></a>                    <span class="kt">size_t</span> <span class="n">node_id</span><span class="p">,</span>
<a name="line-646"></a>                    <span class="n">Edge_Lock_Case</span> <span class="n">lock_case</span>
<a name="line-647"></a>            <span class="p">)</span>
<a name="line-648"></a>            <span class="p">{</span>
<a name="line-649"></a>                <span class="c1">// Iterate over edges of ALL tet</span>
<a name="line-650"></a>                <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">kv</span> <span class="p">:</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">tets</span><span class="p">)</span>
<a name="line-651"></a>                <span class="p">{</span>
<a name="line-652"></a>                    <span class="kt">size_t</span> <span class="n">tet_id</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a name="line-653"></a>                    <span class="n">edge_list_t</span> <span class="n">edge_list</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-654"></a>                    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-655"></a>                    <span class="p">{</span>
<a name="line-656"></a>                        <span class="c1">// If it contains that node id, mark it using lock_case</span>
<a name="line-657"></a>                        <span class="n">edge_t</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">edge_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-658"></a>
<a name="line-659"></a>                        <span class="kt">size_t</span> <span class="n">edge_node_A_id</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">();</span>
<a name="line-660"></a>                        <span class="kt">size_t</span> <span class="n">edge_node_B_id</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">second</span><span class="p">();</span>
<a name="line-661"></a>
<a name="line-662"></a>                        <span class="k">if</span> <span class="p">((</span><span class="n">edge_node_A_id</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">edge_node_B_id</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">))</span> <span class="p">{</span>
<a name="line-663"></a>                            <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; found node in &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">edge_node_A_id</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">edge_node_B_id</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; set to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lock_case</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-664"></a>                            <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">).</span><span class="n">lock_case</span> <span class="o">=</span> <span class="n">lock_case</span><span class="p">;</span>
<a name="line-665"></a>                        <span class="p">}</span>
<a name="line-666"></a>                    <span class="p">}</span>
<a name="line-667"></a>                <span class="p">}</span>
<a name="line-668"></a>            <span class="p">}</span>
<a name="line-669"></a>            <span class="kt">void</span> <span class="nf">lock_edges_from_node</span><span class="p">(</span>
<a name="line-670"></a>                    <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span>
<a name="line-671"></a>                    <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">,</span>
<a name="line-672"></a>                    <span class="kt">size_t</span> <span class="n">node_id</span><span class="p">,</span>
<a name="line-673"></a>                    <span class="n">Edge_Lock_Case</span> <span class="n">lock_case</span>
<a name="line-674"></a>            <span class="p">)</span>
<a name="line-675"></a>            <span class="p">{</span>
<a name="line-676"></a>                <span class="c1">// Iterate over edges of of tet</span>
<a name="line-677"></a>                <span class="n">edge_list_t</span> <span class="n">edge_list</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-678"></a>                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-679"></a>                <span class="p">{</span>
<a name="line-680"></a>                    <span class="c1">// If it contains that node id, mark it using lock_case</span>
<a name="line-681"></a>                    <span class="n">edge_t</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">edge_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-682"></a>
<a name="line-683"></a>                    <span class="kt">size_t</span> <span class="n">edge_node_A_id</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">();</span>
<a name="line-684"></a>                    <span class="kt">size_t</span> <span class="n">edge_node_B_id</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">second</span><span class="p">();</span>
<a name="line-685"></a>
<a name="line-686"></a>                    <span class="k">if</span> <span class="p">((</span><span class="n">edge_node_A_id</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">edge_node_B_id</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">))</span> <span class="p">{</span>
<a name="line-687"></a>                        <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">).</span><span class="n">lock_case</span> <span class="o">=</span> <span class="n">lock_case</span><span class="p">;</span>
<a name="line-688"></a>                    <span class="p">}</span>
<a name="line-689"></a>                <span class="p">}</span>
<a name="line-690"></a>            <span class="p">}</span>
<a name="line-691"></a>
<a name="line-692"></a>
<a name="line-693"></a>            <span class="c1">///// DEREFINEMENT STARTS HERE /////</span>
<a name="line-694"></a>            <span class="cm">/**</span>
<a name="line-695"></a><span class="cm">             * @brief Function to iterate over children and remove them</span>
<a name="line-696"></a><span class="cm">             *</span>
<a name="line-697"></a><span class="cm">             * @param parent_id Id of the parent for whom you will delete the</span>
<a name="line-698"></a><span class="cm">             * children</span>
<a name="line-699"></a><span class="cm">             */</span>
<a name="line-700"></a>            <span class="kt">void</span> <span class="nf">derefine_children</span><span class="p">(</span><span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-701"></a>            <span class="p">{</span>
<a name="line-702"></a>                <span class="c1">// For a given tet_id, find and delete its children</span>
<a name="line-703"></a>                <span class="n">Refinement_State</span><span class="o">&amp;</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-704"></a>                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">parent</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
<a name="line-705"></a>                <span class="p">{</span>
<a name="line-706"></a>                    <span class="n">tet_store</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="line-707"></a>                    <span class="n">parent</span><span class="p">.</span><span class="n">num_children</span><span class="o">--</span><span class="p">;</span> <span class="c1">// Could directly set to 0</span>
<a name="line-708"></a>                <span class="p">}</span>
<a name="line-709"></a>                <span class="n">parent</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a name="line-710"></a>            <span class="p">}</span>
<a name="line-711"></a>
<a name="line-712"></a>            <span class="cm">/**</span>
<a name="line-713"></a><span class="cm">             * @brief Common code for derefinement. Deactives the children and</span>
<a name="line-714"></a><span class="cm">             * actives the parent</span>
<a name="line-715"></a><span class="cm">             *</span>
<a name="line-716"></a><span class="cm">             * @param parent_id The id of the parent</span>
<a name="line-717"></a><span class="cm">             */</span>
<a name="line-718"></a>            <span class="kt">void</span> <span class="nf">generic_derefine</span><span class="p">(</span><span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-719"></a>            <span class="p">{</span>
<a name="line-720"></a>                <span class="n">derefine_children</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-721"></a>                <span class="n">tet_store</span><span class="p">.</span><span class="n">activate</span><span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-722"></a>            <span class="p">}</span>
<a name="line-723"></a>
<a name="line-724"></a>            <span class="c1">// TODO: Document This.</span>
<a name="line-725"></a>            <span class="kt">void</span> <span class="nf">derefine_two_to_one</span><span class="p">(</span><span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-726"></a>            <span class="p">{</span>
<a name="line-727"></a>                <span class="n">delete_intermediates_of_children</span><span class="p">(</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">);</span>
<a name="line-728"></a>                <span class="n">generic_derefine</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-729"></a>            <span class="p">}</span>
<a name="line-730"></a>
<a name="line-731"></a>            <span class="c1">// TODO: Document This.</span>
<a name="line-732"></a>            <span class="kt">void</span> <span class="nf">derefine_four_to_one</span><span class="p">(</span><span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-733"></a>            <span class="p">{</span>
<a name="line-734"></a>                <span class="n">delete_intermediates_of_children</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">);</span>
<a name="line-735"></a>                <span class="n">generic_derefine</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-736"></a>            <span class="p">}</span>
<a name="line-737"></a>
<a name="line-738"></a>            <span class="c1">// TODO: Document This.</span>
<a name="line-739"></a>            <span class="kt">void</span> <span class="nf">derefine_eight_to_one</span><span class="p">(</span><span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-740"></a>            <span class="p">{</span>
<a name="line-741"></a>                <span class="n">generic_derefine</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-742"></a>
<a name="line-743"></a>                <span class="c1">// Delete the center edges</span>
<a name="line-744"></a>                    <span class="c1">// If edge isn&#39;t in the parent, delete it? Is there a better way?</span>
<a name="line-745"></a>                <span class="n">edge_list_t</span> <span class="n">parent_edges</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-746"></a>
<a name="line-747"></a>                <span class="n">Refinement_State</span><span class="o">&amp;</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-748"></a>                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">parent</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
<a name="line-749"></a>                <span class="p">{</span>
<a name="line-750"></a>                    <span class="n">edge_list_t</span> <span class="n">child_edges</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="line-751"></a>                    <span class="n">delete_non_matching_edges</span><span class="p">(</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">child_edges</span><span class="p">,</span> <span class="n">parent_edges</span><span class="p">);</span>
<a name="line-752"></a>                <span class="p">}</span>
<a name="line-753"></a>            <span class="p">}</span>
<a name="line-754"></a>
<a name="line-755"></a>            <span class="c1">// TODO: Document This.</span>
<a name="line-756"></a>            <span class="cm">/*</span>
<a name="line-757"></a><span class="cm">            void derefine_four_to_two(size_t parent_id)</span>
<a name="line-758"></a><span class="cm">            {</span>
<a name="line-759"></a><span class="cm">                assert(0);</span>
<a name="line-760"></a><span class="cm">            }</span>
<a name="line-761"></a>
<a name="line-762"></a><span class="cm">            // TODO: Document This.</span>
<a name="line-763"></a><span class="cm">            void derefine_eight_to_two(size_t parent_id)</span>
<a name="line-764"></a><span class="cm">            {</span>
<a name="line-765"></a><span class="cm">                assert(0);</span>
<a name="line-766"></a><span class="cm">            }</span>
<a name="line-767"></a>
<a name="line-768"></a><span class="cm">            // TODO: Document This.</span>
<a name="line-769"></a><span class="cm">            void derefine_eight_to_four(size_t parent_id)</span>
<a name="line-770"></a><span class="cm">            {</span>
<a name="line-771"></a><span class="cm">                assert(0);</span>
<a name="line-772"></a><span class="cm">            }</span>
<a name="line-773"></a><span class="cm">            */</span>
<a name="line-774"></a>
<a name="line-775"></a>            <span class="cm">/**</span>
<a name="line-776"></a><span class="cm">             * @brief Loop over children and delete all intermediate edges</span>
<a name="line-777"></a><span class="cm">             *</span>
<a name="line-778"></a><span class="cm">             * @param parent_id Id of parent</span>
<a name="line-779"></a><span class="cm">             */</span>
<a name="line-780"></a>            <span class="kt">void</span> <span class="nf">delete_intermediates_of_children</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">parent_id</span><span class="p">)</span>
<a name="line-781"></a>            <span class="p">{</span>
<a name="line-782"></a>                <span class="n">Refinement_State</span><span class="o">&amp;</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
<a name="line-783"></a>                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">parent</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
<a name="line-784"></a>                <span class="p">{</span>
<a name="line-785"></a>                    <span class="n">delete_intermediates</span><span class="p">(</span><span class="n">tet_store</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<a name="line-786"></a>                <span class="p">}</span>
<a name="line-787"></a>            <span class="p">}</span>
<a name="line-788"></a>
<a name="line-789"></a>            <span class="c1">// TODO: Document this</span>
<a name="line-790"></a>            <span class="kt">void</span> <span class="nf">delete_intermediates</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-791"></a>            <span class="p">{</span>
<a name="line-792"></a>                <span class="n">edge_list_t</span> <span class="n">edge_list</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">generate_edge_keys</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-793"></a>                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-794"></a>                <span class="p">{</span>
<a name="line-795"></a>                    <span class="n">edge_t</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">edge_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-796"></a>                    <span class="c1">// accept this code may try delete an edge which has already gone</span>
<a name="line-797"></a>                    <span class="k">if</span> <span class="p">(</span><span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span> <span class="p">{</span>
<a name="line-798"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">).</span><span class="n">lock_case</span> <span class="o">==</span> <span class="n">Edge_Lock_Case</span><span class="o">::</span><span class="n">intermediate</span><span class="p">)</span>
<a name="line-799"></a>                        <span class="p">{</span>
<a name="line-800"></a>                            <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">edge</span><span class="p">);</span>
<a name="line-801"></a>                        <span class="p">}</span>
<a name="line-802"></a>                    <span class="p">}</span>
<a name="line-803"></a>                <span class="p">}</span>
<a name="line-804"></a>            <span class="p">}</span>
<a name="line-805"></a>
<a name="line-806"></a>            <span class="cm">/**</span>
<a name="line-807"></a><span class="cm">             * @brief If edge in candidate is not present in basis, delete the</span>
<a name="line-808"></a><span class="cm">             * edge (candidate) from the main edge store</span>
<a name="line-809"></a><span class="cm">             *</span>
<a name="line-810"></a><span class="cm">             * @param candidate The edge list which is to be searched and deleted</span>
<a name="line-811"></a><span class="cm">             * @param basis The edge list to check against</span>
<a name="line-812"></a><span class="cm">             */</span>
<a name="line-813"></a>            <span class="kt">void</span> <span class="nf">delete_non_matching_edges</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="n">edge_list_t</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">edge_list_t</span> <span class="n">basis</span><span class="p">)</span>
<a name="line-814"></a>            <span class="p">{</span>
<a name="line-815"></a>                <span class="n">trace_out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Looking for edges to delete&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a name="line-816"></a>
<a name="line-817"></a>                <span class="c1">// TODO: Sanity check this now we changed to edge_t</span>
<a name="line-818"></a>
<a name="line-819"></a>                <span class="c1">// Loop over the edges in each child. Look over the basis and</span>
<a name="line-820"></a>                <span class="c1">// if we can&#39;t find it, delete it</span>
<a name="line-821"></a>                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="line-822"></a>                <span class="p">{</span>
<a name="line-823"></a>                    <span class="n">edge_t</span> <span class="n">search_key</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a name="line-824"></a>
<a name="line-825"></a>                    <span class="c1">// Search the basis for it</span>
<a name="line-826"></a>                    <span class="kt">bool</span> <span class="n">found_it</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<a name="line-827"></a>
<a name="line-828"></a>                    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">NUM_TET_EDGES</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
<a name="line-829"></a>                    <span class="p">{</span>
<a name="line-830"></a>                        <span class="n">edge_t</span> <span class="n">key</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
<a name="line-831"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">search_key</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
<a name="line-832"></a>                        <span class="p">{</span>
<a name="line-833"></a>                            <span class="n">found_it</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<a name="line-834"></a>                        <span class="p">}</span>
<a name="line-835"></a>                    <span class="p">}</span>
<a name="line-836"></a>
<a name="line-837"></a>                    <span class="c1">// If we didn&#39;t find it, delete it</span>
<a name="line-838"></a>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_it</span><span class="p">)</span>
<a name="line-839"></a>                    <span class="p">{</span>
<a name="line-840"></a>                        <span class="c1">// Delete it</span>
<a name="line-841"></a>                        <span class="n">tet_store</span><span class="p">.</span><span class="n">edge_store</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">search_key</span><span class="p">);</span>
<a name="line-842"></a>                    <span class="p">}</span>
<a name="line-843"></a>                <span class="p">}</span>
<a name="line-844"></a>            <span class="p">}</span>
<a name="line-845"></a>
<a name="line-846"></a>
<a name="line-847"></a>            <span class="cm">/**</span>
<a name="line-848"></a><span class="cm">             * @brief function to detect when an invalid derefinement is</span>
<a name="line-849"></a><span class="cm">             * invoked</span>
<a name="line-850"></a><span class="cm">             *</span>
<a name="line-851"></a><span class="cm">             * @param tet_id Id the of the tet which will be de-refined</span>
<a name="line-852"></a><span class="cm">             *</span>
<a name="line-853"></a><span class="cm">             * @return A bool stating if the tet can be validly de-refined</span>
<a name="line-854"></a><span class="cm">             */</span>
<a name="line-855"></a>            <span class="kt">bool</span> <span class="nf">check_allowed_derefinement</span><span class="p">(</span> <span class="n">tet_store_t</span><span class="o">&amp;</span> <span class="n">tet_store</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tet_id</span><span class="p">)</span>
<a name="line-856"></a>            <span class="p">{</span>
<a name="line-857"></a>                <span class="n">Refinement_State</span><span class="o">&amp;</span> <span class="n">master_element</span> <span class="o">=</span> <span class="n">tet_store</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">tet_id</span><span class="p">);</span>
<a name="line-858"></a>
<a name="line-859"></a>                <span class="c1">// Check this won&#39;t take us past the max refinement level</span>
<a name="line-860"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">master_element</span><span class="p">.</span><span class="n">refinement_level</span> <span class="o">&lt;=</span> <span class="n">MIN_REFINEMENT_LEVEL</span><span class="p">)</span>
<a name="line-861"></a>                <span class="p">{</span>
<a name="line-862"></a>                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<a name="line-863"></a>                <span class="p">}</span>
<a name="line-864"></a>
<a name="line-865"></a>                <span class="c1">// If we got here, we didn&#39;t detect anything which tells us not</span>
<a name="line-866"></a>                <span class="c1">// to</span>
<a name="line-867"></a>                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<a name="line-868"></a>            <span class="p">}</span>
<a name="line-869"></a>
<a name="line-870"></a>
<a name="line-871"></a>
<a name="line-872"></a>    <span class="p">};</span>
<a name="line-873"></a><span class="p">}</span>
<a name="line-874"></a>
<a name="line-875"></a><span class="cp">#if defined(STRICT_GNUC)</span>
<a name="line-876"></a>  <span class="cp">#pragma GCC diagnostic pop</span>
<a name="line-877"></a><span class="cp">#endif</span>
<a name="line-878"></a>
<a name="line-879"></a><span class="cp">#endif </span><span class="c1">// guard</span>
</pre></div>
</td></tr></table>
      </div>
      <div id="footer">
        <p>
         Cppcheck 1.83 - a tool for static C/C++ code analysis</br>
         </br>
         Internet: <a href="http://cppcheck.net">http://cppcheck.net</a></br>
         IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a></br>
        <p>
      </div>
  </body>
</html>
