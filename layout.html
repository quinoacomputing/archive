<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Large-data memory layout for equation systems | Quinoa docs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="quinoa.m-dark-noindent+doxygen.compiled.css" />
  <link rel="icon" href="quinoa_sum.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">Quinoa <span class="m-thin">docs</span></a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="why.html">Why</a></li>
            <li>
              <a href="build.html">Build</a>
              <ol>
                <li><a href="https://quinoacomputing.org/quinoa.github.io/index.html#mainpage_build">Quickstart</a></li>
                <li><a href="git_submodules_subtrees.html">Modules</a></li>
                <li><a href="licenses.html">Libraries</a></li>
                <li><a href="build_system.html">Internals</a></li>
              </ol>
            </li>
            <li>
              <a href="https://quinoacomputing.org/quinoa.github.io/index.html#mainpage_tools">Tools</a>
              <ol>
                <li><a href="walker_main.html">Walker</a></li>
                <li><a href="inciter_main.html">Inciter</a></li>
                <li><a href="rngtest_main.html">RNGTest</a></li>
                <li><a href="unittest_main.html">UnitTest</a></li>
                <li><a href="meshconv_main.html">MeshConv</a></li>
              </ol>
            </li>
            <li><a href="namespaces.html">Namespaces</a></li>
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="7">
            <li>
              <a href="resources.html">Resources</a>
              <ol>
                <li><a href="https://github.com/quinoacomputing/quinoa">GitHub</a></li>
                <li><a href="https://github.com/quinoacomputing/quinoa/releases">Tarballs</a></li>
                <li><a href="https://github.com/quinoacomputing/quinoa/blob/master/LICENSE">License</a></li>
                <li><a href="roadmap.html">Roadmap</a></li>
                <li><a href="contributing.html">Contributing</a></li>
                <li><a href="papers.html">Publications</a></li>
                <li><a href="https://quinoa.zulipchat.com">Chat</a></li>
                <li><a href="https://quinoa.groups.io">Email list</a></li>
                <li><a href="coverage.html">Coverage</a></li>
                <li><a href="https://dev.azure.com/quinoacomputing/Quinoa">Azure</a></li>
                <li><a href="http://www.openhub.net/p/quinoacomputing">OpenHub</a></li>
                <li><a href="https://bestpractices.coreinfrastructure.org/projects/2120">Practices</a></li>
              </ol>
            </li>
            <li class="m-show-m"><a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          Large-data memory layout for equation systems
        </h1>
        <div class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li><a href="#layout_req">Data layout requirements and design</a></li>
            <li><a href="#layout_possibilities">Possibilities</a></li>
            <li><a href="#layout_preliminary_discussion">Discussion</a></li>
            <li><a href="#layout_blaze">Assessment of the Blaze library that offers a similar choice</a></li>
            <li><a href="#layout_kokkos">Assessment of the Kokkos library that offers a similar choice</a></li>
            <li><a href="#layout_requirements">Requirements</a></li>
            <li>
              <a href="#layout_asm">Data layout implementation and assembly</a>
              <ul>
                <li><a href="#layout_zerocost">Zero-runtime-cost data-layout wrappers with type-based compile-time dispatch</a></li>
                <li><a href="#layout_test">Test of zero-cost</a></li>
                <li><a href="#layout_debugasm">Debug assembly</a></li>
                <li><a href="#layout_excerpt1">Excerpt from the Intel® 64 and IA-32 Architectures Software Developer Manual</a></li>
                <li><a href="#layout_optasm">Optimized assembly</a></li>
                <li><a href="#layout_excerpt2">Excerpt from the Intel® 64 and IA-32 Architectures Software Developer Manual</a></li>

              </ul>
            </li>
            <li>
              <a href="#layout_benchmark">Data layout benchmark</a>
              <ul>
                <li><a href="#layout_input">Quinoa::Walker input file used for the benchmark</a></li>
                <li><a href="#layout_ptr">Ptr - Working with raw pointers</a></li>
                <li><a href="#layout_par">Par - Access via particle-major layout policy</a></li>
                <li><a href="#layout_comparison">Comparison of the algorithms</a></li>
                <li><a href="#layout_asm_discussion">Data layout benchmark discussion</a></li>

              </ul>
            </li>
            <li><a href="#layout_conclusion">Conclusion</a></li>
          </ul>
        </div>
<p>This page discusses the requirements, design, implementation, and verification of a data container with zero-cost compile-time-configurable memory layout for storing a 3-dimensional array of real values. The three dimensions are</p><ol><li><em>Equation</em> index, as required for a coupled multi-system equation solver,</li><li><em>Component</em> index, a specific scalar component of a system of equations, and</li><li><em>Unknown</em> index, as required by some discretization of a numerical solution, representing field variables at discrete locations, e.g., particles or a mesh entity such as cell, face, node, etc.</li></ol><section id="layout_req"><h2><a href="#layout_req">Data layout requirements and design</a></h2><p>How should field values, storing particle properties (in <a href="walker_main.html" class="m-dox">Walker</a>) should be stored in memory? How should mesh field data (associated to nodes, elements, faces, etc., in <a href="inciter_main.html" class="m-dox">Inciter</a>) should be stored in memory? These are the single largest chunks of data a particle-, and/or mesh-based code operates on. The data layout, i.e., how the data is stored and organized in memory, determines how the data is accessed and potentially has a first-degree effect on overall performance.</p></section><section id="layout_possibilities"><h2><a href="#layout_possibilities">Possibilities</a></h2><ol><li><p><strong>Unknown-major</strong>, in which various physical properties, e.g., position, velocity, energy, etc., i.e., the unknowns in a solver, of a single particle or mesh entity are close to each other in memory. For example:</p><div class="m-math"><svg style="width: 22.952em; height: 1.245em;" viewBox="84.100775 -11.955168 220.341448 11.955168">
<title>
\[[ x1, y1, z1, \dots, x2, y2, z2, \dots, x3, y3, z3, \dots ]\]
</title>
<defs>
<path d='M2.199751 -0.573848C2.199751 -0.920548 1.912827 -1.159651 1.625903 -1.159651C1.279203 -1.159651 1.0401 -0.872727 1.0401 -0.585803C1.0401 -0.239103 1.327024 0 1.613948 0C1.960648 0 2.199751 -0.286924 2.199751 -0.573848Z' id='eq1-g0-58'/>
<path d='M2.331258 0.047821C2.331258 -0.645579 2.10411 -1.159651 1.613948 -1.159651C1.231382 -1.159651 1.0401 -0.848817 1.0401 -0.585803S1.219427 0 1.625903 0C1.78132 0 1.912827 -0.047821 2.020423 -0.155417C2.044334 -0.179328 2.056289 -0.179328 2.068244 -0.179328C2.092154 -0.179328 2.092154 -0.011955 2.092154 0.047821C2.092154 0.442341 2.020423 1.219427 1.327024 1.996513C1.195517 2.139975 1.195517 2.163885 1.195517 2.187796C1.195517 2.247572 1.255293 2.307347 1.315068 2.307347C1.41071 2.307347 2.331258 1.422665 2.331258 0.047821Z' id='eq1-g0-59'/>
<path d='M5.66675 -4.877709C5.284184 -4.805978 5.140722 -4.519054 5.140722 -4.291905C5.140722 -4.004981 5.36787 -3.90934 5.535243 -3.90934C5.893898 -3.90934 6.144956 -4.220174 6.144956 -4.542964C6.144956 -5.045081 5.571108 -5.272229 5.068991 -5.272229C4.339726 -5.272229 3.93325 -4.554919 3.825654 -4.327771C3.550685 -5.224408 2.809465 -5.272229 2.594271 -5.272229C1.374844 -5.272229 0.729265 -3.706102 0.729265 -3.443088C0.729265 -3.395268 0.777086 -3.335492 0.860772 -3.335492C0.956413 -3.335492 0.980324 -3.407223 1.004234 -3.455044C1.41071 -4.782067 2.211706 -5.033126 2.558406 -5.033126C3.096389 -5.033126 3.203985 -4.531009 3.203985 -4.244085C3.203985 -3.981071 3.132254 -3.706102 2.988792 -3.132254L2.582316 -1.494396C2.402989 -0.777086 2.056289 -0.119552 1.422665 -0.119552C1.362889 -0.119552 1.06401 -0.119552 0.812951 -0.274969C1.243337 -0.358655 1.338979 -0.71731 1.338979 -0.860772C1.338979 -1.099875 1.159651 -1.243337 0.932503 -1.243337C0.645579 -1.243337 0.334745 -0.992279 0.334745 -0.609714C0.334745 -0.107597 0.896638 0.119552 1.41071 0.119552C1.984558 0.119552 2.391034 -0.334745 2.642092 -0.824907C2.833375 -0.119552 3.431133 0.119552 3.873474 0.119552C5.092902 0.119552 5.738481 -1.446575 5.738481 -1.709589C5.738481 -1.769365 5.69066 -1.817186 5.618929 -1.817186C5.511333 -1.817186 5.499377 -1.75741 5.463512 -1.661768C5.140722 -0.609714 4.447323 -0.119552 3.90934 -0.119552C3.490909 -0.119552 3.263761 -0.430386 3.263761 -0.920548C3.263761 -1.183562 3.311582 -1.374844 3.502864 -2.163885L3.921295 -3.789788C4.100623 -4.507098 4.507098 -5.033126 5.057036 -5.033126C5.080946 -5.033126 5.415691 -5.033126 5.66675 -4.877709Z' id='eq1-g0-120'/>
<path d='M3.144209 1.338979C2.82142 1.793275 2.355168 2.199751 1.769365 2.199751C1.625903 2.199751 1.052055 2.175841 0.872727 1.625903C0.908593 1.637858 0.968369 1.637858 0.992279 1.637858C1.350934 1.637858 1.590037 1.327024 1.590037 1.052055S1.362889 0.681445 1.183562 0.681445C0.992279 0.681445 0.573848 0.824907 0.573848 1.41071C0.573848 2.020423 1.08792 2.438854 1.769365 2.438854C2.964882 2.438854 4.172354 1.338979 4.507098 0.011955L5.678705 -4.65056C5.69066 -4.710336 5.71457 -4.782067 5.71457 -4.853798C5.71457 -5.033126 5.571108 -5.152677 5.391781 -5.152677C5.284184 -5.152677 5.033126 -5.104857 4.937484 -4.746202L4.052802 -1.231382C3.993026 -1.016189 3.993026 -0.992279 3.897385 -0.860772C3.658281 -0.526027 3.263761 -0.119552 2.689913 -0.119552C2.020423 -0.119552 1.960648 -0.777086 1.960648 -1.099875C1.960648 -1.78132 2.283437 -2.701868 2.606227 -3.56264C2.737733 -3.90934 2.809465 -4.076712 2.809465 -4.315816C2.809465 -4.817933 2.450809 -5.272229 1.865006 -5.272229C0.765131 -5.272229 0.32279 -3.53873 0.32279 -3.443088C0.32279 -3.395268 0.37061 -3.335492 0.454296 -3.335492C0.561893 -3.335492 0.573848 -3.383313 0.621669 -3.550685C0.908593 -4.554919 1.362889 -5.033126 1.829141 -5.033126C1.936737 -5.033126 2.139975 -5.033126 2.139975 -4.638605C2.139975 -4.327771 2.008468 -3.981071 1.829141 -3.526775C1.243337 -1.960648 1.243337 -1.566127 1.243337 -1.279203C1.243337 -0.143462 2.056289 0.119552 2.654047 0.119552C3.000747 0.119552 3.431133 0.011955 3.849564 -0.430386L3.861519 -0.418431C3.682192 0.286924 3.56264 0.753176 3.144209 1.338979Z' id='eq1-g0-121'/>
<path d='M1.518306 -0.968369C2.032379 -1.554172 2.450809 -1.924782 3.048568 -2.462765C3.765878 -3.084433 4.076712 -3.383313 4.244085 -3.56264C5.080946 -4.387547 5.499377 -5.080946 5.499377 -5.176588S5.403736 -5.272229 5.379826 -5.272229C5.296139 -5.272229 5.272229 -5.224408 5.212453 -5.140722C4.913574 -4.62665 4.62665 -4.375592 4.315816 -4.375592C4.064757 -4.375592 3.93325 -4.483188 3.706102 -4.770112C3.455044 -5.068991 3.251806 -5.272229 2.905106 -5.272229C2.032379 -5.272229 1.506351 -4.184309 1.506351 -3.93325C1.506351 -3.897385 1.518306 -3.825654 1.625903 -3.825654C1.721544 -3.825654 1.733499 -3.873474 1.769365 -3.957161C1.972603 -4.435367 2.546451 -4.519054 2.773599 -4.519054C3.024658 -4.519054 3.263761 -4.435367 3.514819 -4.327771C3.969116 -4.136488 4.160399 -4.136488 4.27995 -4.136488C4.363636 -4.136488 4.411457 -4.136488 4.471233 -4.148443C4.076712 -3.682192 3.431133 -3.108344 2.893151 -2.618182L1.685679 -1.506351C0.956413 -0.765131 0.514072 -0.059776 0.514072 0.02391C0.514072 0.095641 0.573848 0.119552 0.645579 0.119552S0.729265 0.107597 0.812951 -0.035866C1.004234 -0.334745 1.3868 -0.777086 1.829141 -0.777086C2.080199 -0.777086 2.199751 -0.6934 2.438854 -0.394521C2.666002 -0.131507 2.86924 0.119552 3.251806 0.119552C4.423412 0.119552 5.092902 -1.398755 5.092902 -1.673724C5.092902 -1.721544 5.080946 -1.793275 4.961395 -1.793275C4.865753 -1.793275 4.853798 -1.745455 4.817933 -1.625903C4.554919 -0.920548 3.849564 -0.633624 3.383313 -0.633624C3.132254 -0.633624 2.893151 -0.71731 2.642092 -0.824907C2.163885 -1.016189 2.032379 -1.016189 1.876961 -1.016189C1.75741 -1.016189 1.625903 -1.016189 1.518306 -0.968369Z' id='eq1-g0-122'/>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq1-g1-49'/>
<path d='M5.260274 -2.008468H4.99726C4.961395 -1.80523 4.865753 -1.147696 4.746202 -0.956413C4.662516 -0.848817 3.981071 -0.848817 3.622416 -0.848817H1.41071C1.733499 -1.123786 2.462765 -1.888917 2.773599 -2.175841C4.590785 -3.849564 5.260274 -4.471233 5.260274 -5.654795C5.260274 -7.029639 4.172354 -7.950187 2.785554 -7.950187S0.585803 -6.766625 0.585803 -5.738481C0.585803 -5.128767 1.111831 -5.128767 1.147696 -5.128767C1.398755 -5.128767 1.709589 -5.308095 1.709589 -5.69066C1.709589 -6.025405 1.482441 -6.252553 1.147696 -6.252553C1.0401 -6.252553 1.016189 -6.252553 0.980324 -6.240598C1.207472 -7.053549 1.853051 -7.603487 2.630137 -7.603487C3.646326 -7.603487 4.267995 -6.75467 4.267995 -5.654795C4.267995 -4.638605 3.682192 -3.753923 3.000747 -2.988792L0.585803 -0.286924V0H4.94944L5.260274 -2.008468Z' id='eq1-g1-50'/>
<path d='M2.199751 -4.291905C1.996513 -4.27995 1.948692 -4.267995 1.948692 -4.160399C1.948692 -4.040847 2.008468 -4.040847 2.223661 -4.040847H2.773599C3.789788 -4.040847 4.244085 -3.203985 4.244085 -2.056289C4.244085 -0.490162 3.431133 -0.071731 2.84533 -0.071731C2.271482 -0.071731 1.291158 -0.3467 0.944458 -1.135741C1.327024 -1.075965 1.673724 -1.291158 1.673724 -1.721544C1.673724 -2.068244 1.422665 -2.307347 1.08792 -2.307347C0.800996 -2.307347 0.490162 -2.139975 0.490162 -1.685679C0.490162 -0.621669 1.554172 0.251059 2.881196 0.251059C4.303861 0.251059 5.355915 -0.836862 5.355915 -2.044334C5.355915 -3.144209 4.471233 -4.004981 3.323537 -4.208219C4.363636 -4.507098 5.033126 -5.379826 5.033126 -6.312329C5.033126 -7.256787 4.052802 -7.950187 2.893151 -7.950187C1.697634 -7.950187 0.812951 -7.220922 0.812951 -6.348194C0.812951 -5.869988 1.183562 -5.774346 1.362889 -5.774346C1.613948 -5.774346 1.900872 -5.953674 1.900872 -6.312329C1.900872 -6.694894 1.613948 -6.862267 1.350934 -6.862267C1.279203 -6.862267 1.255293 -6.862267 1.219427 -6.850311C1.673724 -7.663263 2.797509 -7.663263 2.857285 -7.663263C3.251806 -7.663263 4.028892 -7.483935 4.028892 -6.312329C4.028892 -6.085181 3.993026 -5.415691 3.646326 -4.901619C3.287671 -4.375592 2.881196 -4.339726 2.558406 -4.327771L2.199751 -4.291905Z' id='eq1-g1-51'/>
<path d='M2.988792 2.988792V2.546451H1.829141V-8.524035H2.988792V-8.966376H1.3868V2.988792H2.988792Z' id='eq1-g1-91'/>
<path d='M1.853051 -8.966376H0.251059V-8.524035H1.41071V2.546451H0.251059V2.988792H1.853051V-8.966376Z' id='eq1-g1-93'/>
</defs>
<g id='eq1-page1'>
<use x='84.100775' xlink:href='#eq1-g1-91' y='-2.988792'/>
<use x='87.352436' xlink:href='#eq1-g0-120' y='-2.988792'/>
<use x='94.004523' xlink:href='#eq1-g1-49' y='-2.988792'/>
<use x='99.857514' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='105.101673' xlink:href='#eq1-g0-121' y='-2.988792'/>
<use x='111.238324' xlink:href='#eq1-g1-49' y='-2.988792'/>
<use x='117.091315' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='122.335473' xlink:href='#eq1-g0-122' y='-2.988792'/>
<use x='128.30608' xlink:href='#eq1-g1-49' y='-2.988792'/>
<use x='134.15907' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='139.403229' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='144.647388' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='149.891547' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='155.135706' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='160.379864' xlink:href='#eq1-g0-120' y='-2.988792'/>
<use x='167.031952' xlink:href='#eq1-g1-50' y='-2.988792'/>
<use x='172.884942' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='178.129101' xlink:href='#eq1-g0-121' y='-2.988792'/>
<use x='184.265752' xlink:href='#eq1-g1-50' y='-2.988792'/>
<use x='190.118743' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='195.362902' xlink:href='#eq1-g0-122' y='-2.988792'/>
<use x='201.333508' xlink:href='#eq1-g1-50' y='-2.988792'/>
<use x='207.186498' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='212.430657' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='217.674816' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='222.918975' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='228.163134' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='233.407293' xlink:href='#eq1-g0-120' y='-2.988792'/>
<use x='240.05938' xlink:href='#eq1-g1-51' y='-2.988792'/>
<use x='245.91237' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='251.156529' xlink:href='#eq1-g0-121' y='-2.988792'/>
<use x='257.293181' xlink:href='#eq1-g1-51' y='-2.988792'/>
<use x='263.146171' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='268.39033' xlink:href='#eq1-g0-122' y='-2.988792'/>
<use x='274.360936' xlink:href='#eq1-g1-51' y='-2.988792'/>
<use x='280.213926' xlink:href='#eq1-g0-59' y='-2.988792'/>
<use x='285.458085' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='290.702244' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='295.946403' xlink:href='#eq1-g0-58' y='-2.988792'/>
<use x='301.190562' xlink:href='#eq1-g1-93' y='-2.988792'/>
</g>
</svg></div><p>where the <svg class="m-math" style="width: 1.316em; height: 0.579em; vertical-align: -0.000em;" viewBox="0 -5.562484 12.629694 5.562484">
<title>
$x*$
</title>
<defs>
<path d='M3.287671 -5.104857C3.299626 -5.272229 3.299626 -5.559153 2.988792 -5.559153C2.797509 -5.559153 2.642092 -5.403736 2.677958 -5.248319V-5.092902L2.84533 -3.239851L1.315068 -4.351681C1.207472 -4.411457 1.183562 -4.435367 1.099875 -4.435367C0.932503 -4.435367 0.777086 -4.267995 0.777086 -4.100623C0.777086 -3.90934 0.896638 -3.861519 1.016189 -3.801743L2.713823 -2.988792L1.06401 -2.187796C0.872727 -2.092154 0.777086 -2.044334 0.777086 -1.865006S0.932503 -1.530262 1.099875 -1.530262C1.183562 -1.530262 1.207472 -1.530262 1.506351 -1.75741L2.84533 -2.725778L2.666002 -0.71731C2.666002 -0.466252 2.881196 -0.406476 2.976837 -0.406476C3.120299 -0.406476 3.299626 -0.490162 3.299626 -0.71731L3.120299 -2.725778L4.65056 -1.613948C4.758157 -1.554172 4.782067 -1.530262 4.865753 -1.530262C5.033126 -1.530262 5.188543 -1.697634 5.188543 -1.865006C5.188543 -2.044334 5.080946 -2.10411 4.937484 -2.175841C4.220174 -2.534496 4.196264 -2.534496 3.251806 -2.976837L4.901619 -3.777833C5.092902 -3.873474 5.188543 -3.921295 5.188543 -4.100623S5.033126 -4.435367 4.865753 -4.435367C4.782067 -4.435367 4.758157 -4.435367 4.459278 -4.208219L3.120299 -3.239851L3.287671 -5.104857Z' id='eq2-g0-3'/>
<path d='M5.66675 -4.877709C5.284184 -4.805978 5.140722 -4.519054 5.140722 -4.291905C5.140722 -4.004981 5.36787 -3.90934 5.535243 -3.90934C5.893898 -3.90934 6.144956 -4.220174 6.144956 -4.542964C6.144956 -5.045081 5.571108 -5.272229 5.068991 -5.272229C4.339726 -5.272229 3.93325 -4.554919 3.825654 -4.327771C3.550685 -5.224408 2.809465 -5.272229 2.594271 -5.272229C1.374844 -5.272229 0.729265 -3.706102 0.729265 -3.443088C0.729265 -3.395268 0.777086 -3.335492 0.860772 -3.335492C0.956413 -3.335492 0.980324 -3.407223 1.004234 -3.455044C1.41071 -4.782067 2.211706 -5.033126 2.558406 -5.033126C3.096389 -5.033126 3.203985 -4.531009 3.203985 -4.244085C3.203985 -3.981071 3.132254 -3.706102 2.988792 -3.132254L2.582316 -1.494396C2.402989 -0.777086 2.056289 -0.119552 1.422665 -0.119552C1.362889 -0.119552 1.06401 -0.119552 0.812951 -0.274969C1.243337 -0.358655 1.338979 -0.71731 1.338979 -0.860772C1.338979 -1.099875 1.159651 -1.243337 0.932503 -1.243337C0.645579 -1.243337 0.334745 -0.992279 0.334745 -0.609714C0.334745 -0.107597 0.896638 0.119552 1.41071 0.119552C1.984558 0.119552 2.391034 -0.334745 2.642092 -0.824907C2.833375 -0.119552 3.431133 0.119552 3.873474 0.119552C5.092902 0.119552 5.738481 -1.446575 5.738481 -1.709589C5.738481 -1.769365 5.69066 -1.817186 5.618929 -1.817186C5.511333 -1.817186 5.499377 -1.75741 5.463512 -1.661768C5.140722 -0.609714 4.447323 -0.119552 3.90934 -0.119552C3.490909 -0.119552 3.263761 -0.430386 3.263761 -0.920548C3.263761 -1.183562 3.311582 -1.374844 3.502864 -2.163885L3.921295 -3.789788C4.100623 -4.507098 4.507098 -5.033126 5.057036 -5.033126C5.080946 -5.033126 5.415691 -5.033126 5.66675 -4.877709Z' id='eq2-g1-120'/>
</defs>
<g id='eq2-page1'>
<use x='0' xlink:href='#eq2-g1-120' y='0'/>
<use x='6.652087' xlink:href='#eq2-g0-3' y='0'/>
</g>
</svg> are governed by one equation (e.g., position), the <svg class="m-math" style="width: 1.262em; height: 0.822em; vertical-align: -0.243em;" viewBox="0 -5.562484 12.114259 7.887091">
<title>
$y*$
</title>
<defs>
<path d='M3.287671 -5.104857C3.299626 -5.272229 3.299626 -5.559153 2.988792 -5.559153C2.797509 -5.559153 2.642092 -5.403736 2.677958 -5.248319V-5.092902L2.84533 -3.239851L1.315068 -4.351681C1.207472 -4.411457 1.183562 -4.435367 1.099875 -4.435367C0.932503 -4.435367 0.777086 -4.267995 0.777086 -4.100623C0.777086 -3.90934 0.896638 -3.861519 1.016189 -3.801743L2.713823 -2.988792L1.06401 -2.187796C0.872727 -2.092154 0.777086 -2.044334 0.777086 -1.865006S0.932503 -1.530262 1.099875 -1.530262C1.183562 -1.530262 1.207472 -1.530262 1.506351 -1.75741L2.84533 -2.725778L2.666002 -0.71731C2.666002 -0.466252 2.881196 -0.406476 2.976837 -0.406476C3.120299 -0.406476 3.299626 -0.490162 3.299626 -0.71731L3.120299 -2.725778L4.65056 -1.613948C4.758157 -1.554172 4.782067 -1.530262 4.865753 -1.530262C5.033126 -1.530262 5.188543 -1.697634 5.188543 -1.865006C5.188543 -2.044334 5.080946 -2.10411 4.937484 -2.175841C4.220174 -2.534496 4.196264 -2.534496 3.251806 -2.976837L4.901619 -3.777833C5.092902 -3.873474 5.188543 -3.921295 5.188543 -4.100623S5.033126 -4.435367 4.865753 -4.435367C4.782067 -4.435367 4.758157 -4.435367 4.459278 -4.208219L3.120299 -3.239851L3.287671 -5.104857Z' id='eq3-g0-3'/>
<path d='M3.144209 1.338979C2.82142 1.793275 2.355168 2.199751 1.769365 2.199751C1.625903 2.199751 1.052055 2.175841 0.872727 1.625903C0.908593 1.637858 0.968369 1.637858 0.992279 1.637858C1.350934 1.637858 1.590037 1.327024 1.590037 1.052055S1.362889 0.681445 1.183562 0.681445C0.992279 0.681445 0.573848 0.824907 0.573848 1.41071C0.573848 2.020423 1.08792 2.438854 1.769365 2.438854C2.964882 2.438854 4.172354 1.338979 4.507098 0.011955L5.678705 -4.65056C5.69066 -4.710336 5.71457 -4.782067 5.71457 -4.853798C5.71457 -5.033126 5.571108 -5.152677 5.391781 -5.152677C5.284184 -5.152677 5.033126 -5.104857 4.937484 -4.746202L4.052802 -1.231382C3.993026 -1.016189 3.993026 -0.992279 3.897385 -0.860772C3.658281 -0.526027 3.263761 -0.119552 2.689913 -0.119552C2.020423 -0.119552 1.960648 -0.777086 1.960648 -1.099875C1.960648 -1.78132 2.283437 -2.701868 2.606227 -3.56264C2.737733 -3.90934 2.809465 -4.076712 2.809465 -4.315816C2.809465 -4.817933 2.450809 -5.272229 1.865006 -5.272229C0.765131 -5.272229 0.32279 -3.53873 0.32279 -3.443088C0.32279 -3.395268 0.37061 -3.335492 0.454296 -3.335492C0.561893 -3.335492 0.573848 -3.383313 0.621669 -3.550685C0.908593 -4.554919 1.362889 -5.033126 1.829141 -5.033126C1.936737 -5.033126 2.139975 -5.033126 2.139975 -4.638605C2.139975 -4.327771 2.008468 -3.981071 1.829141 -3.526775C1.243337 -1.960648 1.243337 -1.566127 1.243337 -1.279203C1.243337 -0.143462 2.056289 0.119552 2.654047 0.119552C3.000747 0.119552 3.431133 0.011955 3.849564 -0.430386L3.861519 -0.418431C3.682192 0.286924 3.56264 0.753176 3.144209 1.338979Z' id='eq3-g1-121'/>
</defs>
<g id='eq3-page1'>
<use x='0' xlink:href='#eq3-g1-121' y='0'/>
<use x='6.136652' xlink:href='#eq3-g0-3' y='0'/>
</g>
</svg> are governed by another equation (e.g., velocity), and the <svg class="m-math" style="width: 1.245em; height: 0.579em; vertical-align: -0.000em;" viewBox="0 -5.562484 11.948213 5.562484">
<title>
$z*$
</title>
<defs>
<path d='M3.287671 -5.104857C3.299626 -5.272229 3.299626 -5.559153 2.988792 -5.559153C2.797509 -5.559153 2.642092 -5.403736 2.677958 -5.248319V-5.092902L2.84533 -3.239851L1.315068 -4.351681C1.207472 -4.411457 1.183562 -4.435367 1.099875 -4.435367C0.932503 -4.435367 0.777086 -4.267995 0.777086 -4.100623C0.777086 -3.90934 0.896638 -3.861519 1.016189 -3.801743L2.713823 -2.988792L1.06401 -2.187796C0.872727 -2.092154 0.777086 -2.044334 0.777086 -1.865006S0.932503 -1.530262 1.099875 -1.530262C1.183562 -1.530262 1.207472 -1.530262 1.506351 -1.75741L2.84533 -2.725778L2.666002 -0.71731C2.666002 -0.466252 2.881196 -0.406476 2.976837 -0.406476C3.120299 -0.406476 3.299626 -0.490162 3.299626 -0.71731L3.120299 -2.725778L4.65056 -1.613948C4.758157 -1.554172 4.782067 -1.530262 4.865753 -1.530262C5.033126 -1.530262 5.188543 -1.697634 5.188543 -1.865006C5.188543 -2.044334 5.080946 -2.10411 4.937484 -2.175841C4.220174 -2.534496 4.196264 -2.534496 3.251806 -2.976837L4.901619 -3.777833C5.092902 -3.873474 5.188543 -3.921295 5.188543 -4.100623S5.033126 -4.435367 4.865753 -4.435367C4.782067 -4.435367 4.758157 -4.435367 4.459278 -4.208219L3.120299 -3.239851L3.287671 -5.104857Z' id='eq4-g0-3'/>
<path d='M1.518306 -0.968369C2.032379 -1.554172 2.450809 -1.924782 3.048568 -2.462765C3.765878 -3.084433 4.076712 -3.383313 4.244085 -3.56264C5.080946 -4.387547 5.499377 -5.080946 5.499377 -5.176588S5.403736 -5.272229 5.379826 -5.272229C5.296139 -5.272229 5.272229 -5.224408 5.212453 -5.140722C4.913574 -4.62665 4.62665 -4.375592 4.315816 -4.375592C4.064757 -4.375592 3.93325 -4.483188 3.706102 -4.770112C3.455044 -5.068991 3.251806 -5.272229 2.905106 -5.272229C2.032379 -5.272229 1.506351 -4.184309 1.506351 -3.93325C1.506351 -3.897385 1.518306 -3.825654 1.625903 -3.825654C1.721544 -3.825654 1.733499 -3.873474 1.769365 -3.957161C1.972603 -4.435367 2.546451 -4.519054 2.773599 -4.519054C3.024658 -4.519054 3.263761 -4.435367 3.514819 -4.327771C3.969116 -4.136488 4.160399 -4.136488 4.27995 -4.136488C4.363636 -4.136488 4.411457 -4.136488 4.471233 -4.148443C4.076712 -3.682192 3.431133 -3.108344 2.893151 -2.618182L1.685679 -1.506351C0.956413 -0.765131 0.514072 -0.059776 0.514072 0.02391C0.514072 0.095641 0.573848 0.119552 0.645579 0.119552S0.729265 0.107597 0.812951 -0.035866C1.004234 -0.334745 1.3868 -0.777086 1.829141 -0.777086C2.080199 -0.777086 2.199751 -0.6934 2.438854 -0.394521C2.666002 -0.131507 2.86924 0.119552 3.251806 0.119552C4.423412 0.119552 5.092902 -1.398755 5.092902 -1.673724C5.092902 -1.721544 5.080946 -1.793275 4.961395 -1.793275C4.865753 -1.793275 4.853798 -1.745455 4.817933 -1.625903C4.554919 -0.920548 3.849564 -0.633624 3.383313 -0.633624C3.132254 -0.633624 2.893151 -0.71731 2.642092 -0.824907C2.163885 -1.016189 2.032379 -1.016189 1.876961 -1.016189C1.75741 -1.016189 1.625903 -1.016189 1.518306 -0.968369Z' id='eq4-g1-122'/>
</defs>
<g id='eq4-page1'>
<use x='0' xlink:href='#eq4-g1-122' y='0'/>
<use x='5.970606' xlink:href='#eq4-g0-3' y='0'/>
</g>
</svg> are governed by a third equation (e.g., energy), etc. Here the first letter denotes a physical quantity, while the second is the particle number or mesh entity index. If the algorithm advances the properties at the unknowns one equation at a time, data in memory is accessed by having to jump a distance that corresponds to the number of scalar physical variables per particle or mesh entity. In the example, the update will have to jump as <svg class="m-math" style="width: 6.978em; height: 1.045em; vertical-align: -0.243em;" viewBox="0 -7.704442 66.987688 10.029049">
<title>
$x1, x2, x3, \dots$
</title>
<defs>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq5-g1-49'/>
<path d='M5.260274 -2.008468H4.99726C4.961395 -1.80523 4.865753 -1.147696 4.746202 -0.956413C4.662516 -0.848817 3.981071 -0.848817 3.622416 -0.848817H1.41071C1.733499 -1.123786 2.462765 -1.888917 2.773599 -2.175841C4.590785 -3.849564 5.260274 -4.471233 5.260274 -5.654795C5.260274 -7.029639 4.172354 -7.950187 2.785554 -7.950187S0.585803 -6.766625 0.585803 -5.738481C0.585803 -5.128767 1.111831 -5.128767 1.147696 -5.128767C1.398755 -5.128767 1.709589 -5.308095 1.709589 -5.69066C1.709589 -6.025405 1.482441 -6.252553 1.147696 -6.252553C1.0401 -6.252553 1.016189 -6.252553 0.980324 -6.240598C1.207472 -7.053549 1.853051 -7.603487 2.630137 -7.603487C3.646326 -7.603487 4.267995 -6.75467 4.267995 -5.654795C4.267995 -4.638605 3.682192 -3.753923 3.000747 -2.988792L0.585803 -0.286924V0H4.94944L5.260274 -2.008468Z' id='eq5-g1-50'/>
<path d='M2.199751 -4.291905C1.996513 -4.27995 1.948692 -4.267995 1.948692 -4.160399C1.948692 -4.040847 2.008468 -4.040847 2.223661 -4.040847H2.773599C3.789788 -4.040847 4.244085 -3.203985 4.244085 -2.056289C4.244085 -0.490162 3.431133 -0.071731 2.84533 -0.071731C2.271482 -0.071731 1.291158 -0.3467 0.944458 -1.135741C1.327024 -1.075965 1.673724 -1.291158 1.673724 -1.721544C1.673724 -2.068244 1.422665 -2.307347 1.08792 -2.307347C0.800996 -2.307347 0.490162 -2.139975 0.490162 -1.685679C0.490162 -0.621669 1.554172 0.251059 2.881196 0.251059C4.303861 0.251059 5.355915 -0.836862 5.355915 -2.044334C5.355915 -3.144209 4.471233 -4.004981 3.323537 -4.208219C4.363636 -4.507098 5.033126 -5.379826 5.033126 -6.312329C5.033126 -7.256787 4.052802 -7.950187 2.893151 -7.950187C1.697634 -7.950187 0.812951 -7.220922 0.812951 -6.348194C0.812951 -5.869988 1.183562 -5.774346 1.362889 -5.774346C1.613948 -5.774346 1.900872 -5.953674 1.900872 -6.312329C1.900872 -6.694894 1.613948 -6.862267 1.350934 -6.862267C1.279203 -6.862267 1.255293 -6.862267 1.219427 -6.850311C1.673724 -7.663263 2.797509 -7.663263 2.857285 -7.663263C3.251806 -7.663263 4.028892 -7.483935 4.028892 -6.312329C4.028892 -6.085181 3.993026 -5.415691 3.646326 -4.901619C3.287671 -4.375592 2.881196 -4.339726 2.558406 -4.327771L2.199751 -4.291905Z' id='eq5-g1-51'/>
<path d='M2.199751 -0.573848C2.199751 -0.920548 1.912827 -1.159651 1.625903 -1.159651C1.279203 -1.159651 1.0401 -0.872727 1.0401 -0.585803C1.0401 -0.239103 1.327024 0 1.613948 0C1.960648 0 2.199751 -0.286924 2.199751 -0.573848Z' id='eq5-g0-58'/>
<path d='M2.331258 0.047821C2.331258 -0.645579 2.10411 -1.159651 1.613948 -1.159651C1.231382 -1.159651 1.0401 -0.848817 1.0401 -0.585803S1.219427 0 1.625903 0C1.78132 0 1.912827 -0.047821 2.020423 -0.155417C2.044334 -0.179328 2.056289 -0.179328 2.068244 -0.179328C2.092154 -0.179328 2.092154 -0.011955 2.092154 0.047821C2.092154 0.442341 2.020423 1.219427 1.327024 1.996513C1.195517 2.139975 1.195517 2.163885 1.195517 2.187796C1.195517 2.247572 1.255293 2.307347 1.315068 2.307347C1.41071 2.307347 2.331258 1.422665 2.331258 0.047821Z' id='eq5-g0-59'/>
<path d='M5.66675 -4.877709C5.284184 -4.805978 5.140722 -4.519054 5.140722 -4.291905C5.140722 -4.004981 5.36787 -3.90934 5.535243 -3.90934C5.893898 -3.90934 6.144956 -4.220174 6.144956 -4.542964C6.144956 -5.045081 5.571108 -5.272229 5.068991 -5.272229C4.339726 -5.272229 3.93325 -4.554919 3.825654 -4.327771C3.550685 -5.224408 2.809465 -5.272229 2.594271 -5.272229C1.374844 -5.272229 0.729265 -3.706102 0.729265 -3.443088C0.729265 -3.395268 0.777086 -3.335492 0.860772 -3.335492C0.956413 -3.335492 0.980324 -3.407223 1.004234 -3.455044C1.41071 -4.782067 2.211706 -5.033126 2.558406 -5.033126C3.096389 -5.033126 3.203985 -4.531009 3.203985 -4.244085C3.203985 -3.981071 3.132254 -3.706102 2.988792 -3.132254L2.582316 -1.494396C2.402989 -0.777086 2.056289 -0.119552 1.422665 -0.119552C1.362889 -0.119552 1.06401 -0.119552 0.812951 -0.274969C1.243337 -0.358655 1.338979 -0.71731 1.338979 -0.860772C1.338979 -1.099875 1.159651 -1.243337 0.932503 -1.243337C0.645579 -1.243337 0.334745 -0.992279 0.334745 -0.609714C0.334745 -0.107597 0.896638 0.119552 1.41071 0.119552C1.984558 0.119552 2.391034 -0.334745 2.642092 -0.824907C2.833375 -0.119552 3.431133 0.119552 3.873474 0.119552C5.092902 0.119552 5.738481 -1.446575 5.738481 -1.709589C5.738481 -1.769365 5.69066 -1.817186 5.618929 -1.817186C5.511333 -1.817186 5.499377 -1.75741 5.463512 -1.661768C5.140722 -0.609714 4.447323 -0.119552 3.90934 -0.119552C3.490909 -0.119552 3.263761 -0.430386 3.263761 -0.920548C3.263761 -1.183562 3.311582 -1.374844 3.502864 -2.163885L3.921295 -3.789788C4.100623 -4.507098 4.507098 -5.033126 5.057036 -5.033126C5.080946 -5.033126 5.415691 -5.033126 5.66675 -4.877709Z' id='eq5-g0-120'/>
</defs>
<g id='eq5-page1'>
<use x='0' xlink:href='#eq5-g0-120' y='0'/>
<use x='6.652087' xlink:href='#eq5-g1-49' y='0'/>
<use x='12.505077' xlink:href='#eq5-g0-59' y='0'/>
<use x='17.749236' xlink:href='#eq5-g0-120' y='0'/>
<use x='24.401323' xlink:href='#eq5-g1-50' y='0'/>
<use x='30.254314' xlink:href='#eq5-g0-59' y='0'/>
<use x='35.498473' xlink:href='#eq5-g0-120' y='0'/>
<use x='42.15056' xlink:href='#eq5-g1-51' y='0'/>
<use x='48.00355' xlink:href='#eq5-g0-59' y='0'/>
<use x='53.247709' xlink:href='#eq5-g0-58' y='0'/>
<use x='58.491868' xlink:href='#eq5-g0-58' y='0'/>
<use x='63.736027' xlink:href='#eq5-g0-58' y='0'/>
</g>
</svg> are updated.</p></li><li><p><strong>Property-major</strong>, in which the same type of physical properties are close to each other in memory. For example,</p><div class="m-math"><svg style="width: 22.952em; height: 1.245em;" viewBox="84.100775 -11.955168 220.341448 11.955168">
<title>
\[[ x1, x2, x3, \dots, y1, y2, y3, \dots, z1, z2, z3, \dots ]\]
</title>
<defs>
<path d='M2.199751 -0.573848C2.199751 -0.920548 1.912827 -1.159651 1.625903 -1.159651C1.279203 -1.159651 1.0401 -0.872727 1.0401 -0.585803C1.0401 -0.239103 1.327024 0 1.613948 0C1.960648 0 2.199751 -0.286924 2.199751 -0.573848Z' id='eq6-g0-58'/>
<path d='M2.331258 0.047821C2.331258 -0.645579 2.10411 -1.159651 1.613948 -1.159651C1.231382 -1.159651 1.0401 -0.848817 1.0401 -0.585803S1.219427 0 1.625903 0C1.78132 0 1.912827 -0.047821 2.020423 -0.155417C2.044334 -0.179328 2.056289 -0.179328 2.068244 -0.179328C2.092154 -0.179328 2.092154 -0.011955 2.092154 0.047821C2.092154 0.442341 2.020423 1.219427 1.327024 1.996513C1.195517 2.139975 1.195517 2.163885 1.195517 2.187796C1.195517 2.247572 1.255293 2.307347 1.315068 2.307347C1.41071 2.307347 2.331258 1.422665 2.331258 0.047821Z' id='eq6-g0-59'/>
<path d='M5.66675 -4.877709C5.284184 -4.805978 5.140722 -4.519054 5.140722 -4.291905C5.140722 -4.004981 5.36787 -3.90934 5.535243 -3.90934C5.893898 -3.90934 6.144956 -4.220174 6.144956 -4.542964C6.144956 -5.045081 5.571108 -5.272229 5.068991 -5.272229C4.339726 -5.272229 3.93325 -4.554919 3.825654 -4.327771C3.550685 -5.224408 2.809465 -5.272229 2.594271 -5.272229C1.374844 -5.272229 0.729265 -3.706102 0.729265 -3.443088C0.729265 -3.395268 0.777086 -3.335492 0.860772 -3.335492C0.956413 -3.335492 0.980324 -3.407223 1.004234 -3.455044C1.41071 -4.782067 2.211706 -5.033126 2.558406 -5.033126C3.096389 -5.033126 3.203985 -4.531009 3.203985 -4.244085C3.203985 -3.981071 3.132254 -3.706102 2.988792 -3.132254L2.582316 -1.494396C2.402989 -0.777086 2.056289 -0.119552 1.422665 -0.119552C1.362889 -0.119552 1.06401 -0.119552 0.812951 -0.274969C1.243337 -0.358655 1.338979 -0.71731 1.338979 -0.860772C1.338979 -1.099875 1.159651 -1.243337 0.932503 -1.243337C0.645579 -1.243337 0.334745 -0.992279 0.334745 -0.609714C0.334745 -0.107597 0.896638 0.119552 1.41071 0.119552C1.984558 0.119552 2.391034 -0.334745 2.642092 -0.824907C2.833375 -0.119552 3.431133 0.119552 3.873474 0.119552C5.092902 0.119552 5.738481 -1.446575 5.738481 -1.709589C5.738481 -1.769365 5.69066 -1.817186 5.618929 -1.817186C5.511333 -1.817186 5.499377 -1.75741 5.463512 -1.661768C5.140722 -0.609714 4.447323 -0.119552 3.90934 -0.119552C3.490909 -0.119552 3.263761 -0.430386 3.263761 -0.920548C3.263761 -1.183562 3.311582 -1.374844 3.502864 -2.163885L3.921295 -3.789788C4.100623 -4.507098 4.507098 -5.033126 5.057036 -5.033126C5.080946 -5.033126 5.415691 -5.033126 5.66675 -4.877709Z' id='eq6-g0-120'/>
<path d='M3.144209 1.338979C2.82142 1.793275 2.355168 2.199751 1.769365 2.199751C1.625903 2.199751 1.052055 2.175841 0.872727 1.625903C0.908593 1.637858 0.968369 1.637858 0.992279 1.637858C1.350934 1.637858 1.590037 1.327024 1.590037 1.052055S1.362889 0.681445 1.183562 0.681445C0.992279 0.681445 0.573848 0.824907 0.573848 1.41071C0.573848 2.020423 1.08792 2.438854 1.769365 2.438854C2.964882 2.438854 4.172354 1.338979 4.507098 0.011955L5.678705 -4.65056C5.69066 -4.710336 5.71457 -4.782067 5.71457 -4.853798C5.71457 -5.033126 5.571108 -5.152677 5.391781 -5.152677C5.284184 -5.152677 5.033126 -5.104857 4.937484 -4.746202L4.052802 -1.231382C3.993026 -1.016189 3.993026 -0.992279 3.897385 -0.860772C3.658281 -0.526027 3.263761 -0.119552 2.689913 -0.119552C2.020423 -0.119552 1.960648 -0.777086 1.960648 -1.099875C1.960648 -1.78132 2.283437 -2.701868 2.606227 -3.56264C2.737733 -3.90934 2.809465 -4.076712 2.809465 -4.315816C2.809465 -4.817933 2.450809 -5.272229 1.865006 -5.272229C0.765131 -5.272229 0.32279 -3.53873 0.32279 -3.443088C0.32279 -3.395268 0.37061 -3.335492 0.454296 -3.335492C0.561893 -3.335492 0.573848 -3.383313 0.621669 -3.550685C0.908593 -4.554919 1.362889 -5.033126 1.829141 -5.033126C1.936737 -5.033126 2.139975 -5.033126 2.139975 -4.638605C2.139975 -4.327771 2.008468 -3.981071 1.829141 -3.526775C1.243337 -1.960648 1.243337 -1.566127 1.243337 -1.279203C1.243337 -0.143462 2.056289 0.119552 2.654047 0.119552C3.000747 0.119552 3.431133 0.011955 3.849564 -0.430386L3.861519 -0.418431C3.682192 0.286924 3.56264 0.753176 3.144209 1.338979Z' id='eq6-g0-121'/>
<path d='M1.518306 -0.968369C2.032379 -1.554172 2.450809 -1.924782 3.048568 -2.462765C3.765878 -3.084433 4.076712 -3.383313 4.244085 -3.56264C5.080946 -4.387547 5.499377 -5.080946 5.499377 -5.176588S5.403736 -5.272229 5.379826 -5.272229C5.296139 -5.272229 5.272229 -5.224408 5.212453 -5.140722C4.913574 -4.62665 4.62665 -4.375592 4.315816 -4.375592C4.064757 -4.375592 3.93325 -4.483188 3.706102 -4.770112C3.455044 -5.068991 3.251806 -5.272229 2.905106 -5.272229C2.032379 -5.272229 1.506351 -4.184309 1.506351 -3.93325C1.506351 -3.897385 1.518306 -3.825654 1.625903 -3.825654C1.721544 -3.825654 1.733499 -3.873474 1.769365 -3.957161C1.972603 -4.435367 2.546451 -4.519054 2.773599 -4.519054C3.024658 -4.519054 3.263761 -4.435367 3.514819 -4.327771C3.969116 -4.136488 4.160399 -4.136488 4.27995 -4.136488C4.363636 -4.136488 4.411457 -4.136488 4.471233 -4.148443C4.076712 -3.682192 3.431133 -3.108344 2.893151 -2.618182L1.685679 -1.506351C0.956413 -0.765131 0.514072 -0.059776 0.514072 0.02391C0.514072 0.095641 0.573848 0.119552 0.645579 0.119552S0.729265 0.107597 0.812951 -0.035866C1.004234 -0.334745 1.3868 -0.777086 1.829141 -0.777086C2.080199 -0.777086 2.199751 -0.6934 2.438854 -0.394521C2.666002 -0.131507 2.86924 0.119552 3.251806 0.119552C4.423412 0.119552 5.092902 -1.398755 5.092902 -1.673724C5.092902 -1.721544 5.080946 -1.793275 4.961395 -1.793275C4.865753 -1.793275 4.853798 -1.745455 4.817933 -1.625903C4.554919 -0.920548 3.849564 -0.633624 3.383313 -0.633624C3.132254 -0.633624 2.893151 -0.71731 2.642092 -0.824907C2.163885 -1.016189 2.032379 -1.016189 1.876961 -1.016189C1.75741 -1.016189 1.625903 -1.016189 1.518306 -0.968369Z' id='eq6-g0-122'/>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq6-g1-49'/>
<path d='M5.260274 -2.008468H4.99726C4.961395 -1.80523 4.865753 -1.147696 4.746202 -0.956413C4.662516 -0.848817 3.981071 -0.848817 3.622416 -0.848817H1.41071C1.733499 -1.123786 2.462765 -1.888917 2.773599 -2.175841C4.590785 -3.849564 5.260274 -4.471233 5.260274 -5.654795C5.260274 -7.029639 4.172354 -7.950187 2.785554 -7.950187S0.585803 -6.766625 0.585803 -5.738481C0.585803 -5.128767 1.111831 -5.128767 1.147696 -5.128767C1.398755 -5.128767 1.709589 -5.308095 1.709589 -5.69066C1.709589 -6.025405 1.482441 -6.252553 1.147696 -6.252553C1.0401 -6.252553 1.016189 -6.252553 0.980324 -6.240598C1.207472 -7.053549 1.853051 -7.603487 2.630137 -7.603487C3.646326 -7.603487 4.267995 -6.75467 4.267995 -5.654795C4.267995 -4.638605 3.682192 -3.753923 3.000747 -2.988792L0.585803 -0.286924V0H4.94944L5.260274 -2.008468Z' id='eq6-g1-50'/>
<path d='M2.199751 -4.291905C1.996513 -4.27995 1.948692 -4.267995 1.948692 -4.160399C1.948692 -4.040847 2.008468 -4.040847 2.223661 -4.040847H2.773599C3.789788 -4.040847 4.244085 -3.203985 4.244085 -2.056289C4.244085 -0.490162 3.431133 -0.071731 2.84533 -0.071731C2.271482 -0.071731 1.291158 -0.3467 0.944458 -1.135741C1.327024 -1.075965 1.673724 -1.291158 1.673724 -1.721544C1.673724 -2.068244 1.422665 -2.307347 1.08792 -2.307347C0.800996 -2.307347 0.490162 -2.139975 0.490162 -1.685679C0.490162 -0.621669 1.554172 0.251059 2.881196 0.251059C4.303861 0.251059 5.355915 -0.836862 5.355915 -2.044334C5.355915 -3.144209 4.471233 -4.004981 3.323537 -4.208219C4.363636 -4.507098 5.033126 -5.379826 5.033126 -6.312329C5.033126 -7.256787 4.052802 -7.950187 2.893151 -7.950187C1.697634 -7.950187 0.812951 -7.220922 0.812951 -6.348194C0.812951 -5.869988 1.183562 -5.774346 1.362889 -5.774346C1.613948 -5.774346 1.900872 -5.953674 1.900872 -6.312329C1.900872 -6.694894 1.613948 -6.862267 1.350934 -6.862267C1.279203 -6.862267 1.255293 -6.862267 1.219427 -6.850311C1.673724 -7.663263 2.797509 -7.663263 2.857285 -7.663263C3.251806 -7.663263 4.028892 -7.483935 4.028892 -6.312329C4.028892 -6.085181 3.993026 -5.415691 3.646326 -4.901619C3.287671 -4.375592 2.881196 -4.339726 2.558406 -4.327771L2.199751 -4.291905Z' id='eq6-g1-51'/>
<path d='M2.988792 2.988792V2.546451H1.829141V-8.524035H2.988792V-8.966376H1.3868V2.988792H2.988792Z' id='eq6-g1-91'/>
<path d='M1.853051 -8.966376H0.251059V-8.524035H1.41071V2.546451H0.251059V2.988792H1.853051V-8.966376Z' id='eq6-g1-93'/>
</defs>
<g id='eq6-page1'>
<use x='84.100775' xlink:href='#eq6-g1-91' y='-2.988792'/>
<use x='87.352436' xlink:href='#eq6-g0-120' y='-2.988792'/>
<use x='94.004523' xlink:href='#eq6-g1-49' y='-2.988792'/>
<use x='99.857514' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='105.101673' xlink:href='#eq6-g0-120' y='-2.988792'/>
<use x='111.75376' xlink:href='#eq6-g1-50' y='-2.988792'/>
<use x='117.60675' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='122.850909' xlink:href='#eq6-g0-120' y='-2.988792'/>
<use x='129.502996' xlink:href='#eq6-g1-51' y='-2.988792'/>
<use x='135.355986' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='140.600145' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='145.844304' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='151.088463' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='156.332622' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='161.576781' xlink:href='#eq6-g0-121' y='-2.988792'/>
<use x='167.713432' xlink:href='#eq6-g1-49' y='-2.988792'/>
<use x='173.566423' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='178.810581' xlink:href='#eq6-g0-121' y='-2.988792'/>
<use x='184.947233' xlink:href='#eq6-g1-50' y='-2.988792'/>
<use x='190.800223' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='196.044382' xlink:href='#eq6-g0-121' y='-2.988792'/>
<use x='202.181034' xlink:href='#eq6-g1-51' y='-2.988792'/>
<use x='208.034024' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='213.278183' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='218.522342' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='223.766501' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='229.01066' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='234.254819' xlink:href='#eq6-g0-122' y='-2.988792'/>
<use x='240.225425' xlink:href='#eq6-g1-49' y='-2.988792'/>
<use x='246.078415' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='251.322574' xlink:href='#eq6-g0-122' y='-2.988792'/>
<use x='257.293181' xlink:href='#eq6-g1-50' y='-2.988792'/>
<use x='263.146171' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='268.39033' xlink:href='#eq6-g0-122' y='-2.988792'/>
<use x='274.360936' xlink:href='#eq6-g1-51' y='-2.988792'/>
<use x='280.213926' xlink:href='#eq6-g0-59' y='-2.988792'/>
<use x='285.458085' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='290.702244' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='295.946403' xlink:href='#eq6-g0-58' y='-2.988792'/>
<use x='301.190562' xlink:href='#eq6-g1-93' y='-2.988792'/>
</g>
</svg></div><p>The legend here is the same as in unknown-major: the first letter denotes a physical quantity, while the second is the particle or mesh entity index. If the algorithm advances the properties at the unknowns one equation at a time, data in memory is accessed contiguously in memory as the properties are contiguously stored.</p></li></ol></section><section id="layout_preliminary_discussion"><h2><a href="#layout_preliminary_discussion">Discussion</a></h2><p>A property-major storage, case 2 above, seems to be the most efficient at first sight, as it stores data, as it is read and written by the equation algorithms, contiguously. However, data access is contiguous only if the particle properties (or data stored at mesh entities) are independent, i.e., if there is no coupling among the equations. Unfortunately, this is rarely the case, at least not for fluid dynamics or any computational physics problem that is interesting enough. For example in a Lagrangian particle code, velocity is used by the position update, and velocity is required by the energy update. The same is true for a mesh-based solver, where the physical variables are coupled, i.e., their update needs other physical variables at the same mesh entity (and usually that of the neighbors). Depending on the physical approximation, density (or mass) may be required for all equations. The stronger the equations are coupled, the more far-reads are required for a given update with a property-major data layout. These far-reads are practically always cache misses, as the property-major storage stores the physical variables for the same particle or mesh entity very far in memory, e.g., the distance between <svg class="m-math" style="width: 1.303em; height: 0.803em; vertical-align: -0.000em;" viewBox="0 -7.704442 12.505077 7.704442">
<title>
$x1$
</title>
<defs>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq7-g1-49'/>
<path d='M5.66675 -4.877709C5.284184 -4.805978 5.140722 -4.519054 5.140722 -4.291905C5.140722 -4.004981 5.36787 -3.90934 5.535243 -3.90934C5.893898 -3.90934 6.144956 -4.220174 6.144956 -4.542964C6.144956 -5.045081 5.571108 -5.272229 5.068991 -5.272229C4.339726 -5.272229 3.93325 -4.554919 3.825654 -4.327771C3.550685 -5.224408 2.809465 -5.272229 2.594271 -5.272229C1.374844 -5.272229 0.729265 -3.706102 0.729265 -3.443088C0.729265 -3.395268 0.777086 -3.335492 0.860772 -3.335492C0.956413 -3.335492 0.980324 -3.407223 1.004234 -3.455044C1.41071 -4.782067 2.211706 -5.033126 2.558406 -5.033126C3.096389 -5.033126 3.203985 -4.531009 3.203985 -4.244085C3.203985 -3.981071 3.132254 -3.706102 2.988792 -3.132254L2.582316 -1.494396C2.402989 -0.777086 2.056289 -0.119552 1.422665 -0.119552C1.362889 -0.119552 1.06401 -0.119552 0.812951 -0.274969C1.243337 -0.358655 1.338979 -0.71731 1.338979 -0.860772C1.338979 -1.099875 1.159651 -1.243337 0.932503 -1.243337C0.645579 -1.243337 0.334745 -0.992279 0.334745 -0.609714C0.334745 -0.107597 0.896638 0.119552 1.41071 0.119552C1.984558 0.119552 2.391034 -0.334745 2.642092 -0.824907C2.833375 -0.119552 3.431133 0.119552 3.873474 0.119552C5.092902 0.119552 5.738481 -1.446575 5.738481 -1.709589C5.738481 -1.769365 5.69066 -1.817186 5.618929 -1.817186C5.511333 -1.817186 5.499377 -1.75741 5.463512 -1.661768C5.140722 -0.609714 4.447323 -0.119552 3.90934 -0.119552C3.490909 -0.119552 3.263761 -0.430386 3.263761 -0.920548C3.263761 -1.183562 3.311582 -1.374844 3.502864 -2.163885L3.921295 -3.789788C4.100623 -4.507098 4.507098 -5.033126 5.057036 -5.033126C5.080946 -5.033126 5.415691 -5.033126 5.66675 -4.877709Z' id='eq7-g0-120'/>
</defs>
<g id='eq7-page1'>
<use x='0' xlink:href='#eq7-g0-120' y='0'/>
<use x='6.652087' xlink:href='#eq7-g1-49' y='0'/>
</g>
</svg> and <svg class="m-math" style="width: 1.249em; height: 1.045em; vertical-align: -0.243em;" viewBox="0 -7.704442 11.989642 10.029049">
<title>
$y1$
</title>
<defs>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq8-g1-49'/>
<path d='M3.144209 1.338979C2.82142 1.793275 2.355168 2.199751 1.769365 2.199751C1.625903 2.199751 1.052055 2.175841 0.872727 1.625903C0.908593 1.637858 0.968369 1.637858 0.992279 1.637858C1.350934 1.637858 1.590037 1.327024 1.590037 1.052055S1.362889 0.681445 1.183562 0.681445C0.992279 0.681445 0.573848 0.824907 0.573848 1.41071C0.573848 2.020423 1.08792 2.438854 1.769365 2.438854C2.964882 2.438854 4.172354 1.338979 4.507098 0.011955L5.678705 -4.65056C5.69066 -4.710336 5.71457 -4.782067 5.71457 -4.853798C5.71457 -5.033126 5.571108 -5.152677 5.391781 -5.152677C5.284184 -5.152677 5.033126 -5.104857 4.937484 -4.746202L4.052802 -1.231382C3.993026 -1.016189 3.993026 -0.992279 3.897385 -0.860772C3.658281 -0.526027 3.263761 -0.119552 2.689913 -0.119552C2.020423 -0.119552 1.960648 -0.777086 1.960648 -1.099875C1.960648 -1.78132 2.283437 -2.701868 2.606227 -3.56264C2.737733 -3.90934 2.809465 -4.076712 2.809465 -4.315816C2.809465 -4.817933 2.450809 -5.272229 1.865006 -5.272229C0.765131 -5.272229 0.32279 -3.53873 0.32279 -3.443088C0.32279 -3.395268 0.37061 -3.335492 0.454296 -3.335492C0.561893 -3.335492 0.573848 -3.383313 0.621669 -3.550685C0.908593 -4.554919 1.362889 -5.033126 1.829141 -5.033126C1.936737 -5.033126 2.139975 -5.033126 2.139975 -4.638605C2.139975 -4.327771 2.008468 -3.981071 1.829141 -3.526775C1.243337 -1.960648 1.243337 -1.566127 1.243337 -1.279203C1.243337 -0.143462 2.056289 0.119552 2.654047 0.119552C3.000747 0.119552 3.431133 0.011955 3.849564 -0.430386L3.861519 -0.418431C3.682192 0.286924 3.56264 0.753176 3.144209 1.338979Z' id='eq8-g0-121'/>
</defs>
<g id='eq8-page1'>
<use x='0' xlink:href='#eq8-g0-121' y='0'/>
<use x='6.136652' xlink:href='#eq8-g1-49' y='0'/>
</g>
</svg> is the number of particles or mesh entities. While the unknown-major storage, case 1 above, inherently stores data non-contiguously, the distance between properties of a single particle (or a single mesh entity) is relatively small, i.e., the number of properties, which may incur less cache misses as several particles (or nodes) but all of their physical properties at the same unknown could fit into cache.</p><p>Assuming strong coupling among the variables, the unknown-major storage will be favored, but it would be nice if the design allowed for both layouts, so depending on the type of equations the most appropriate layout could be selected. If such a design is maintainable, there is still a question whether the data layout selection should be done at compile-, or run-time.</p></section><section id="layout_blaze"><h2><a href="#layout_blaze">Assessment of the Blaze library that offers a similar choice</a></h2><p>Have looked at <a href="https://bitbucket.org/blaze-lib/blaze">https:/<wbr />/<wbr />bitbucket.org/<wbr />blaze-lib/<wbr />blaze</a> which implements row-, and column-major matrix classes based on a template argument. See, e.g., <code>&lt;blaze-1.5&gt;/blaze/math/dense/StaticMatrix.h</code>, which reveals that the template argument (bool) <code class="m-code"><span class="n">SO</span></code> selects between row-, or column-major internal storage. Then <code class="m-code"><span class="n">SO</span></code> is used at both compile-time (e.g., by the class-user, when instantiating the type of the matrix), as well as run-time (e.g., the implementation of <code class="m-code"><span class="n">isDefault</span><span class="p">()</span></code>). Both compile-time and run-time usage of the SO template arguments are problematic:</p><ul><li>The compile-time usage duplicates a lot of code by having to provide similar implementations for the element-access <code class="m-code"><span class="k">operator</span><span class="p">()</span></code> of <code class="m-code"><span class="n">StaticMatrix</span></code> specialized to column-major. There is a generic implementation for <code class="m-code"><span class="n">SO</span></code> for everything that is agnostic of <code class="m-code"><span class="n">SO</span></code>, and there is a specialization when <code class="m-code"><span class="n">SO</span></code> is column-major.</li><li>The run-time usage also duplicates code by doing an if-test on <code class="m-code"><span class="n">SO</span></code> in, e.g., <code class="m-code"><span class="n">isDefault</span><span class="p">()</span></code>. Is there a better way of doing this? If there are only two types of data layout (unknown-, and property-major), code duplication should not be too much of an issue. However, the implementation of unknown-property data access must be absolutely zero run-time cost. This means the selection must be at compile-time and the element access must be absolutely invisible to client code. In other words, there must be no re-implementation of a time-integrator for an equation just because the data access is different.</li></ul></section><section id="layout_kokkos"><h2><a href="#layout_kokkos">Assessment of the Kokkos library that offers a similar choice</a></h2><p>Since the first implementation of the configurable data layout, described below, the Kokkos library, <a href="https://github.com/kokkos/kokkos">https:/<wbr />/<wbr />github.com/<wbr />kokkos/<wbr />kokkos</a> , from Sandia National Labs, has been released. Kokkos appears to have all the requirements described here, and many more other features. It does have compile-time configurable data layouts, <code class="m-code"><span class="n">views</span></code>, for the purpose of optimal data access on various compute devices, such as multi-core CPUs, many-core accelerators, and Graphics Processing Units. Kokkos appears to provide an excellent abstraction for data layout abstraction. However, Kokkos provides a lot more functionality than just data layout abstraction, e.g., it can generate low level code for various devices using its configurable views. The currently available Kokkos back-ends are OpenMP, pthreads, and CUDA. Thus Kokkos provides abstractions for shared-memory parallelism. While Kokkos has been successfully used in Charm++ code, at this point (Jan 2016) we opt for <em>not</em> adopting Kokkos&#x27; views and keep our original data layout abstractions, discussed below. The reasons:</p><ul><li>At this point we are too early in the development of Quinoa and its tools to be able to say that the current abstractions Charm++ provides are sufficient or not to strike the correct balance between performance and productivity. In particular, it could be possible that Charm++&#x27;s abstractions (using overdecomposition), which we use already, are enough. In that case, using a single abstraction for parallelism is preferable to two.</li><li>At this point we would really only need the compile-time configurable data layout abstractions from Kokkos and not the other rich features, such as abstractions for loop-level shared-memory parallelism.</li></ul><p>As far I can tell, the views of an array in Kokkos provide a very similar abstraction for data layout and thus memory access what is described below.</p></section><section id="layout_requirements"><h2><a href="#layout_requirements">Requirements</a></h2><div class="m-block m-center-m m-note">Is it possible to implement a compile-time configurable data-access policy via a thin data-access interface with zero run-time cost, no code-duplication, and in a way that is invisible to client code? <strong>Yes.</strong> See below.</div><p>Zero-cost is achieved via type-based compile-time polymorphism. This is controlled via a cmake variable.</p><p>The particle (or mesh entity) data is a logically 3-dimensional array that stores the particle properties or unknowns at mesh entities, e.g., faces, cell centers, nodes, etc.</p><p>For clarity, the discussion below will use the expression &quot;particle&quot; for a particle-code and will not specifically mention mesh-based unknowns, stored at the nodes, elements, faces, etc., of a computational mesh. The former is for a particle-code, the latter is for a mesh-code. The data layout discussion is independent of whether particles or mesh entities (nodes, cells, etc.) are used, and accordingly both <a href="walker_main.html" class="m-dox">Walker</a> and <a href="inciter_main.html" class="m-dox">Inciter</a> uses the same implementation.</p><p>In principle there are a total of 6 permutations:</p><pre>1. ParEqComp: [ particle ] [ equation ] [ component ]
2. ParCompEq: [ particle ] [ component ] [ equation ]
3. EqCompPar: [ equation ] [ component ] [ particle ]
4. EqParComp: [ equation ] [ particle ] [ component ]
5. CompEqPar: [ component ] [ equation ] [ particle ]
6. CompParEq: [ component ] [ particle ] [ equation ]
</pre><p>Of these 6 we only consider those where <em>component</em> follows <em>equation</em>. (For those layouts where <em>equation</em> follows <em>component</em> the access would be unnecessarily complicated by the potentially unequal number of components for different equations which is not known at compile-time and thus does not allow some optimizations.) This decision leaves us with the following choices:</p><pre>1. ParEqComp: [ particle ] [ equation ] [ component ]
3. EqCompPar: [ equation ] [ component ] [ particle ]
4. EqParComp: [ equation ] [ particle ] [ component ]
</pre><p>Access is based on the 3 coordinates: <em>particle</em> (or <em>unknown</em>), <em>component</em>, and <em>offset</em>. <em>Particle</em> is the particle index, component denotes the given component of a vector equation, e.g., velocity has 3 components, a multi-material turbulent mix model governed by the Dirichlet SDE has <svg class="m-math" style="width: 6.005em; height: 0.955em; vertical-align: -0.104em;" viewBox="0 -8.169366 57.651414 9.165637">
<title>
$K=N-1$
</title>
<defs>
<path d='M7.878456 -2.749689C8.081694 -2.749689 8.296887 -2.749689 8.296887 -2.988792S8.081694 -3.227895 7.878456 -3.227895H1.41071C1.207472 -3.227895 0.992279 -3.227895 0.992279 -2.988792S1.207472 -2.749689 1.41071 -2.749689H7.878456Z' id='eq9-g0-0'/>
<path d='M3.443088 -7.663263C3.443088 -7.938232 3.443088 -7.950187 3.203985 -7.950187C2.917061 -7.627397 2.319303 -7.185056 1.08792 -7.185056V-6.838356C1.362889 -6.838356 1.960648 -6.838356 2.618182 -7.149191V-0.920548C2.618182 -0.490162 2.582316 -0.3467 1.530262 -0.3467H1.159651V0C1.482441 -0.02391 2.642092 -0.02391 3.036613 -0.02391S4.578829 -0.02391 4.901619 0V-0.3467H4.531009C3.478954 -0.3467 3.443088 -0.490162 3.443088 -0.920548V-7.663263Z' id='eq9-g2-49'/>
<path d='M8.069738 -3.873474C8.237111 -3.873474 8.452304 -3.873474 8.452304 -4.088667C8.452304 -4.315816 8.249066 -4.315816 8.069738 -4.315816H1.028144C0.860772 -4.315816 0.645579 -4.315816 0.645579 -4.100623C0.645579 -3.873474 0.848817 -3.873474 1.028144 -3.873474H8.069738ZM8.069738 -1.649813C8.237111 -1.649813 8.452304 -1.649813 8.452304 -1.865006C8.452304 -2.092154 8.249066 -2.092154 8.069738 -2.092154H1.028144C0.860772 -2.092154 0.645579 -2.092154 0.645579 -1.876961C0.645579 -1.649813 0.848817 -1.649813 1.028144 -1.649813H8.069738Z' id='eq9-g2-61'/>
<path d='M5.977584 -4.829888C5.965629 -4.865753 5.917808 -4.961395 5.917808 -4.99726C5.917808 -5.009215 5.929763 -5.021171 6.133001 -5.176588L7.292653 -6.085181C8.894645 -7.328518 9.420672 -7.746949 10.245579 -7.81868C10.329265 -7.830635 10.448817 -7.830635 10.448817 -8.033873C10.448817 -8.105604 10.412951 -8.16538 10.31731 -8.16538C10.185803 -8.16538 10.042341 -8.141469 9.910834 -8.141469H9.456538C9.085928 -8.141469 8.691407 -8.16538 8.332752 -8.16538C8.249066 -8.16538 8.105604 -8.16538 8.105604 -7.950187C8.105604 -7.830635 8.18929 -7.81868 8.261021 -7.81868C8.392528 -7.806725 8.547945 -7.758904 8.547945 -7.591532C8.547945 -7.352428 8.18929 -7.065504 8.093649 -6.993773L3.407223 -3.347447L4.399502 -7.292653C4.507098 -7.699128 4.531009 -7.81868 5.379826 -7.81868C5.606974 -7.81868 5.71457 -7.81868 5.71457 -8.045828C5.71457 -8.16538 5.595019 -8.16538 5.535243 -8.16538C5.32005 -8.16538 5.068991 -8.141469 4.841843 -8.141469H3.431133C3.21594 -8.141469 2.952927 -8.16538 2.737733 -8.16538C2.642092 -8.16538 2.510585 -8.16538 2.510585 -7.938232C2.510585 -7.81868 2.618182 -7.81868 2.797509 -7.81868C3.526775 -7.81868 3.526775 -7.723039 3.526775 -7.591532C3.526775 -7.567621 3.526775 -7.49589 3.478954 -7.316563L1.865006 -0.884682C1.75741 -0.466252 1.733499 -0.3467 0.896638 -0.3467C0.669489 -0.3467 0.549938 -0.3467 0.549938 -0.131507C0.549938 0 0.657534 0 0.729265 0C0.956413 0 1.195517 -0.02391 1.422665 -0.02391H2.82142C3.048568 -0.02391 3.299626 0 3.526775 0C3.622416 0 3.753923 0 3.753923 -0.227148C3.753923 -0.3467 3.646326 -0.3467 3.466999 -0.3467C2.737733 -0.3467 2.737733 -0.442341 2.737733 -0.561893C2.737733 -0.645579 2.809465 -0.944458 2.857285 -1.135741L3.323537 -2.988792L5.140722 -4.411457C5.487422 -3.646326 6.121046 -2.116065 6.611208 -0.944458C6.647073 -0.872727 6.670984 -0.800996 6.670984 -0.71731C6.670984 -0.358655 6.192777 -0.3467 6.085181 -0.3467S5.858032 -0.3467 5.858032 -0.119552C5.858032 0 5.989539 0 6.025405 0C6.443836 0 6.886177 -0.02391 7.304608 -0.02391H7.878456C8.057783 -0.02391 8.261021 0 8.440349 0C8.51208 0 8.643587 0 8.643587 -0.227148C8.643587 -0.3467 8.53599 -0.3467 8.416438 -0.3467C7.974097 -0.358655 7.81868 -0.454296 7.639352 -0.884682L5.977584 -4.829888Z' id='eq9-g1-75'/>
<path d='M8.846824 -6.910087C8.978331 -7.424159 9.169614 -7.782814 10.078207 -7.81868C10.114072 -7.81868 10.257534 -7.830635 10.257534 -8.033873C10.257534 -8.16538 10.149938 -8.16538 10.102117 -8.16538C9.863014 -8.16538 9.2533 -8.141469 9.014197 -8.141469H8.440349C8.272976 -8.141469 8.057783 -8.16538 7.890411 -8.16538C7.81868 -8.16538 7.675218 -8.16538 7.675218 -7.938232C7.675218 -7.81868 7.770859 -7.81868 7.854545 -7.81868C8.571856 -7.79477 8.619676 -7.519801 8.619676 -7.304608C8.619676 -7.197011 8.607721 -7.161146 8.571856 -6.993773L7.220922 -1.601993L4.662516 -7.962142C4.578829 -8.153425 4.566874 -8.16538 4.303861 -8.16538H2.84533C2.606227 -8.16538 2.49863 -8.16538 2.49863 -7.938232C2.49863 -7.81868 2.582316 -7.81868 2.809465 -7.81868C2.86924 -7.81868 3.574595 -7.81868 3.574595 -7.711083C3.574595 -7.687173 3.550685 -7.591532 3.53873 -7.555666L1.948692 -1.219427C1.80523 -0.633624 1.518306 -0.382565 0.729265 -0.3467C0.669489 -0.3467 0.549938 -0.334745 0.549938 -0.119552C0.549938 0 0.669489 0 0.705355 0C0.944458 0 1.554172 -0.02391 1.793275 -0.02391H2.367123C2.534496 -0.02391 2.737733 0 2.905106 0C2.988792 0 3.120299 0 3.120299 -0.227148C3.120299 -0.334745 3.000747 -0.3467 2.952927 -0.3467C2.558406 -0.358655 2.175841 -0.430386 2.175841 -0.860772C2.175841 -0.956413 2.199751 -1.06401 2.223661 -1.159651L3.837609 -7.555666C3.90934 -7.436115 3.90934 -7.412204 3.957161 -7.304608L6.802491 -0.215193C6.862267 -0.071731 6.886177 0 6.993773 0C7.113325 0 7.12528 -0.035866 7.173101 -0.239103L8.846824 -6.910087Z' id='eq9-g1-78'/>
</defs>
<g id='eq9-page1'>
<use x='0' xlink:href='#eq9-g1-75' y='0'/>
<use x='14.138509' xlink:href='#eq9-g2-61' y='0'/>
<use x='26.56399' xlink:href='#eq9-g1-78' y='0'/>
<use x='39.843264' xlink:href='#eq9-g0-0' y='0'/>
<use x='51.798424' xlink:href='#eq9-g2-49' y='0'/>
</g>
</svg> scalars (components), and <em>offset</em> is determined by the relative position of the given equation compared to the other equations. Using these 3 coordinates the index calculations for the above 3 cases are:</p><pre>1. ParEqComp: [ particle ] [ equation ] [ component ]

     baseptr + particle*nprop + offset + component
</pre><p>where <em>nprop</em> is the total number of particle properties, e.g., 3 positions, 3 velocities, 5 scalars <svg class="m-math" style="width: 1.245em; height: 0.291em; vertical-align: -0.000em;" viewBox="0 -4.386049 11.955202 2.794513">
<title>
$\to$
</title>
<defs>
<path d='M9.97061 -2.749689C9.313076 -2.247572 8.990286 -1.75741 8.894645 -1.601993C8.356663 -0.777086 8.261021 -0.02391 8.261021 -0.011955C8.261021 0.131507 8.404483 0.131507 8.500125 0.131507C8.703362 0.131507 8.715318 0.107597 8.763138 -0.107597C9.038107 -1.279203 9.743462 -2.283437 11.094396 -2.833375C11.237858 -2.881196 11.273724 -2.905106 11.273724 -2.988792S11.201993 -3.108344 11.178082 -3.120299C10.652055 -3.323537 9.205479 -3.921295 8.751183 -5.929763C8.715318 -6.073225 8.703362 -6.109091 8.500125 -6.109091C8.404483 -6.109091 8.261021 -6.109091 8.261021 -5.965629C8.261021 -5.941719 8.368618 -5.188543 8.870735 -4.387547C9.109838 -4.028892 9.456538 -3.610461 9.97061 -3.227895H1.08792C0.872727 -3.227895 0.657534 -3.227895 0.657534 -2.988792S0.872727 -2.749689 1.08792 -2.749689H9.97061Z' id='eq10-g0-33'/>
</defs>
<g id='eq10-page1'>
<use x='0' xlink:href='#eq10-g0-33' y='0'/>
</g>
</svg> nprop = 11.</p><pre>3. EqCompPar: [ equation ] [ component ] [ particle ]

     baseptr + (offset+component)*npar + particle
</pre><p>where <em>npar</em> is the total number of particles.</p><pre>4. EqParComp: [ equation ] [ particle ] [ component ]

     baseptr + offset*npar + nce*particle + component
</pre><p>where <em>nce</em> is the number of components for the given equation. Since this would require another function argument (besides <em>particle</em>, <em>component</em>, and <em>offset</em>), and it costs an integer-multiply more than the other two layouts, we dismiss this layout, and only implement the following two:</p><pre>1. ParEqComp - Particle-major
3. EqCompPar - Equation-major
</pre><p>These options are exposed via a cmake variable and can be switched before a build.</p></section><section id="layout_asm"><h2><a href="#layout_asm">Data layout implementation and assembly</a></h2><p>This section documents the implementation and the assembly code, produced by the compilers, of the compile-time configurable data-access policy discussed above. The implementation is via a thin data-access interface with zero run-time cost, no code-duplication, and in a way that is invisible to client code.</p><section id="layout_zerocost"><h3><a href="#layout_zerocost">Zero-runtime-cost data-layout wrappers with type-based compile-time dispatch</a></h3><p>Tags for selecting particle-, or property-major data layout policies:</p><pre class="m-code"><span class="k">const</span> <span class="kt">bool</span> <span class="n">ParticleMajor</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">bool</span> <span class="n">PropertyMajor</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre><p>Essentially, the implementation is as follows:</p><pre class="m-code"><span class="k">template</span><span class="o">&lt;</span> <span class="kt">bool</span> <span class="n">Major</span> <span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Data</span> <span class="p">{</span>

  <span class="k">private</span><span class="o">:</span>
   <span class="c1">// Transform a compile-time bool into a type</span>
   <span class="k">template</span><span class="o">&lt;</span> <span class="kt">bool</span> <span class="n">m</span> <span class="o">&gt;</span>
   <span class="k">struct</span> <span class="nc">int2type</span> <span class="p">{</span>
     <span class="k">enum</span> <span class="p">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">m</span> <span class="p">};</span>
   <span class="p">};</span>

   <span class="c1">// Overloads for particle-, and property-major accesses</span>
   <span class="kr">inline</span>
   <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">&amp;</span> <span class="n">access</span><span class="p">(</span> <span class="kt">int</span> <span class="n">particle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">property</span><span class="p">,</span> <span class="n">int2type</span><span class="o">&lt;</span><span class="n">ParticleMajor</span><span class="o">&gt;</span> <span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">m_ptr</span> <span class="o">+</span> <span class="n">particle</span><span class="o">*</span><span class="n">m_nprop</span> <span class="o">+</span> <span class="n">m_offset</span> <span class="o">+</span> <span class="n">property</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kr">inline</span>
   <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">&amp;</span> <span class="n">access</span><span class="p">(</span> <span class="kt">int</span> <span class="n">particle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">property</span><span class="p">,</span> <span class="n">int2type</span><span class="o">&lt;</span><span class="n">PropertyMajor</span><span class="o">&gt;</span> <span class="p">)</span> <span class="p">{</span>
     <span class="c1">// This is the same for now, not called, irrelevant in zero-cost-test</span>
     <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">m_ptr</span> <span class="o">+</span> <span class="n">particle</span><span class="o">*</span><span class="n">m_nprop</span> <span class="o">+</span> <span class="n">m_offset</span> <span class="o">+</span> <span class="n">property</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">*</span> <span class="k">const</span> <span class="n">m_ptr</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">int</span> <span class="n">m_nprop</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">int</span> <span class="n">m_offset</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="c1">// Constructor</span>
    <span class="n">Data</span><span class="p">(</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">*</span> <span class="k">const</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nprop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span> <span class="p">)</span> <span class="o">:</span>
      <span class="n">m_ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">m_nprop</span><span class="p">(</span><span class="n">nprop</span><span class="p">),</span> <span class="n">m_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{}</span>

    <span class="c1">// Access dispatch</span>
    <span class="kr">inline</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span> <span class="kt">int</span> <span class="n">particle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">property</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nf">access</span><span class="p">(</span> <span class="n">particle</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">int2type</span><span class="o">&lt;</span><span class="n">Major</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></pre></section><section id="layout_test"><h3><a href="#layout_test">Test of zero-cost</a></h3><p>Test by adding to <code class="m-code"><span class="n">Dirichlet</span></code> (derived equation class) constructor (client code):</p><pre class="m-code"><span class="n">Data</span><span class="o">&lt;</span> <span class="n">Layout</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">(</span> <span class="n">particles</span><span class="p">,</span> <span class="n">m_nprop</span><span class="p">,</span> <span class="n">m_offset</span> <span class="p">);</span>
<span class="n">Model</span><span class="o">::</span><span class="n">aa</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
<span class="n">Model</span><span class="o">::</span><span class="n">bb</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">m_particles</span> <span class="o">+</span> <span class="mi">34</span><span class="o">*</span><span class="n">m_nprop</span> <span class="o">+</span> <span class="n">m_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span></pre><p>Add to <code class="m-code"><span class="n">Model</span></code>:</p><pre class="m-code"><span class="n">Model</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">aa</span><span class="p">;</span>
    <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">bb</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span></pre><p>Add to <code class="m-code"><span class="n">Physics</span></code> constructor:</p><pre class="m-code"><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">m_mix</span><span class="o">-&gt;</span><span class="n">aa</span> <span class="o">&lt;&lt;</span> <span class="n">m_mix</span><span class="o">-&gt;</span><span class="n">bb</span><span class="p">;</span></pre><p>This is so the optimizing compiler cannot entirely optimize the assignments of <code class="m-code"><span class="n">aa</span></code> and <code class="m-code"><span class="n">bb</span></code> away.</p></section><section id="layout_debugasm"><h3><a href="#layout_debugasm">Debug assembly</a></h3><p>Generated assembly code with <code class="m-code"><span class="err">CMAKE_BUILD_TYPE=DEBUG</span></code> (i.e., without optimization) of the assignments of <code class="m-code"><span class="n">aa</span></code> (line 42) and <code class="m-code"><span class="n">bb</span></code> (line 43) in <code class="m-code"><span class="n">Dirichlet</span></code>&#x27;s constructor, with <code class="m-code">clang -g -S -mllvm --x86-asm-syntax<span class="o">=</span>intel</code>, gnu and intel generate very similar code:</p><pre class="m-code">     <span class="nf">.loc</span>    <span class="mi">143</span> <span class="mi">42</span> <span class="mi">20</span>  <span class="c1">; &lt;quinoa&gt;/src/DiffEq/Dirichlet.h:42:20</span>
<span class="nl">.Ltmp27038:</span>
     <span class="nf">lea</span>     <span class="nb">RDI</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RBP</span> <span class="o">-</span> <span class="mi">56</span><span class="p">]</span>
     <span class="nf">mov</span>     <span class="nb">ESI</span><span class="p">,</span> <span class="mi">34</span>
     <span class="nf">mov</span>     <span class="nb">EDX</span><span class="p">,</span> <span class="mi">3</span>
     <span class="nf">call</span>    <span class="nv">_ZN6quinoa4DataILb1EEclEii</span>
<span class="nl">.Ltmp27039:</span>
     <span class="nf">mov</span>     <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RBP</span> <span class="o">-</span> <span class="mi">176</span><span class="p">],</span> <span class="nb">RAX</span> <span class="err">#</span> <span class="mi">8</span><span class="o">-</span><span class="kt">byte</span> <span class="nb">Sp</span><span class="nv">ill</span>
     <span class="nf">jmp</span>     <span class="nv">.LBB2550_7</span>
<span class="nl">.LBB2550_7:</span>
     <span class="nf">mov</span>     <span class="nb">RAX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RBP</span> <span class="o">-</span> <span class="mi">176</span><span class="p">]</span> <span class="err">#</span> <span class="mi">8</span><span class="o">-</span><span class="kt">byte</span> <span class="nv">Reload</span>
     <span class="nf">movsd</span>   <span class="nv">XMM0</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RAX</span><span class="p">]</span>
     <span class="nf">mov</span>     <span class="nb">RCX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RBP</span> <span class="o">-</span> <span class="mi">64</span><span class="p">]</span> <span class="err">#</span> <span class="mi">8</span><span class="o">-</span><span class="kt">byte</span> <span class="nv">Reload</span>
     <span class="nf">movsd</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="nv">XMM0</span>
     <span class="nf">.loc</span>    <span class="mi">143</span> <span class="mi">43</span> <span class="mi">0</span>    <span class="c1">; &lt;quinoa&gt;/src/DiffEq/Dirichlet.h:43:0</span>
     <span class="nf">mov</span>     <span class="nb">RDX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
     <span class="nf">imul</span>    <span class="nb">ESI</span><span class="p">,</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">48</span><span class="p">],</span> <span class="mi">34</span>
     <span class="nf">movsxd</span>  <span class="nb">RDI</span><span class="p">,</span> <span class="nb">ESI</span>
     <span class="nf">shl</span>     <span class="nb">RDI</span><span class="p">,</span> <span class="mi">3</span>
     <span class="nf">add</span>     <span class="nb">RDX</span><span class="p">,</span> <span class="nb">RDI</span>
     <span class="nf">movsxd</span>  <span class="nb">RDI</span><span class="p">,</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">52</span><span class="p">]</span>
     <span class="nf">movsd</span>   <span class="nv">XMM0</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="nb">RDI</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
     <span class="nf">movsd</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="nv">XMM0</span></pre><p>Line 42 translates to register loads and a function call into <code class="m-code"><span class="n">tk</span><span class="o">::</span><span class="n">Data</span></code>, while line 43 translates to some integer arithmetic of the address and loads.</p></section><section id="layout_excerpt1"><h3><a href="#layout_excerpt1">Excerpt from the Intel® 64 and IA-32 Architectures Software Developer Manual</a></h3><blockquote><p>The LEA (load effective address) instruction computes the effective address in memory (offset within a segment) of a source operand and places it in a general-purpose register. This instruction can interpret any of the processor’s addressing modes and can perform any indexing or scaling that may be needed. It is especially useful for initializing the ESI or EDI registers before the execution of string instructions or for initializing the EBX register before an XLAT instruction.</p><p>The MOVSXD instruction operates on 64-bit data. It sign-extends a 32-bit value to 64 bits. This instruction is not encodable in non-64-bit modes.</p><p>A common type of operation on packed integers is the conversion by zero- or sign-extension of packed integers into wider data types. SSE4.1 adds 12 instructions that convert from a smaller packed integer type to a larger integer type (PMOVSXBW, PMOVZXBW, PMOVSXBD, PMOVZXBD, PMOVSXWD, PMOVZXWD, PMOVSXBQ, PMOVZXBQ, PMOVSXWQ, PMOVZXWQ, PMOVSXDQ, PMOVZXDQ). The source operand is from either an XMM register or memory; the destination is an XMM register.</p><p>IMUL Signed multiply. The IMUL instruction multiplies two signed integer operands. The result is computed to twice the size of the source operands; however, in some cases the result is truncated to the size of the source operands.</p><p>SAL/SHL Shift arithmetic left/Shift logical left. The SAL (shift arithmetic left), SHL (shift logical left), SAR (shift arithmetic right), SHR (shift logical right) instructions perform an arithmetic or logical shift of the bits in a byte, word, or doubleword. The SAL and SHL instructions perform the same operation. They shift the source operand left by from 1 to 31 bit positions. Empty bit positions are cleared. The CF flag is loaded with the last bit shifted out of the operand.</p></blockquote></section><section id="layout_optasm"><h3><a href="#layout_optasm">Optimized assembly</a></h3><p>Generated assembly code with <code class="m-code"><span class="err">CMAKE_BUILD_TYPE=RELWITHDEBINFO</span></code> (i.e., with optimization) of the assignments of <code class="m-code"><span class="n">aa</span></code> (line 42) and <code class="m-code"><span class="n">bb</span></code> (line 43) in <code class="m-code"><span class="n">Dirichlet</span></code>&#x27;s constructor, with <code class="m-code">clang -O2 -g DNDEBUG -S -mllvm --x86-asm-syntax<span class="o">=</span>intel</code>, gnu and intel generate very similar optimized code:</p><pre class="m-code"><span class="nf">.loc</span>    <span class="mi">144</span> <span class="mi">42</span> <span class="mi">20</span>  <span class="c1">; &lt;quinoa&gt;/src/DiffEq/Dirichlet.h:42:20</span>
<span class="nf">movsd</span>   <span class="nv">XMM0</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">R14</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="nb">RAX</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
<span class="nf">movsd</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">R13</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="nv">XMM0</span>
<span class="nf">.loc</span>    <span class="mi">144</span> <span class="mi">43</span> <span class="mi">0</span>    <span class="c1">; &lt;quinoa&gt;/src/DiffEq/Dirichlet.h:43:0</span>
<span class="nf">mov</span>     <span class="nb">RCX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">R13</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
<span class="nf">movsd</span>   <span class="nv">XMM0</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RCX</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="nb">RAX</span> <span class="o">+</span> <span class="mi">24</span><span class="p">]</span>
<span class="nf">movsd</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">R13</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="nv">XMM0</span></pre><p>Both lines 42 and 43 translate to very similar SSE loads with pointer arithmetic, i.e., line 42 costs the same as line 43.</p></section><section id="layout_excerpt2"><h3><a href="#layout_excerpt2">Excerpt from the Intel® 64 and IA-32 Architectures Software Developer Manual</a></h3><blockquote><p>The MOVS instruction moves the string element addressed by the ESI register to the location addressed by the EDI register. The assembler recognizes three “short forms” of this instruction, which specify the size of the string to be moved: MOVSB (move byte string), MOVSW (move word string), and MOVSD (move doubleword string).</p><p>The MOVSD (move scalar double-precision floating-point) instruction transfers a 64-bit double-precision floating- point operand from memory to the low quadword of an XMM register or vice versa, or between XMM registers. Alignment of the memory address is not required, unless alignment checking is enabled.</p></blockquote></section></section><section id="layout_benchmark"><h2><a href="#layout_benchmark">Data layout benchmark</a></h2><p>This section documents the benchmark of the implementation of the compile-time configurable data-access policy discussed above. The implementation is via a thin data-access interface with zero run-time cost, no code-duplication, and in a way that is invisible to client code.</p><section id="layout_input"><h3><a href="#layout_input">Quinoa::Walker input file used for the benchmark</a></h3><p>We will integrate for the duration of a 100,000 time steps a system of 100 coupled non-linear stochastic differential equations (SDEs) whose statistically stationary solution converge to the Dirichlet distribution and measure the wall-clock time. For more on the Dirichlet SDE, see <a href="https://github.com/quinoacomputing/quinoa/blob/master/src/DiffEq/Dirichlet.h">src/<wbr />DiffEq/<wbr />Dirichlet.h</a>.</p><pre class="m-code">walker

  nstep <span class="m">100000</span>  <span class="c1"># Max number of time steps</span>
  term  <span class="m">140</span>.0   <span class="c1"># Max time</span>
  dt    <span class="m">0</span>.05    <span class="c1"># Time step size</span>
  npar  <span class="m">40000</span>   <span class="c1"># Number of particles</span>

  ttyi  <span class="m">100</span>     <span class="c1"># TTY output interval</span>

  rngs
    mkl_mrg32k3a seed <span class="m">0</span> end
  end

  dirichlet
    ncomp <span class="m">100</span>  <span class="c1"># = K = N-1</span>
    b     <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
          <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5 <span class="m">0</span>.1 <span class="m">1</span>.5
    end
    S     <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
          <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4 <span class="m">0</span>.625 <span class="m">0</span>.4
    end
    kappa <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
          <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3 <span class="m">0</span>.0125 <span class="m">0</span>.3
    end
    rng mkl_mrg32k3a
  end

  statistics    <span class="c1"># Estimate statistics</span>
    &lt;Y1&gt;        <span class="c1"># mean of Y1</span>
    &lt;Y2&gt;
    &lt;y1y1&gt;      <span class="c1"># variance of Y1 = &lt;(Y1-&lt;Y1&gt;)^2&gt; = &lt;y1^2&gt;</span>
    &lt;y2y2&gt;
    &lt;y1y2&gt;
  end

end</pre></section><section id="layout_ptr"><h3><a href="#layout_ptr">Ptr - Working with raw pointers</a></h3><p>This algorithm gets the starting raw pointer from which the given particle data is (contiguously) accessible in memory and simply adds integers to the address to access and update the 100 components specified above. The algorithm assumes a particular data layout &ndash; it only works with the particle-major storage &ndash; a logically 3-dimensional array with [ particle ] [ equation ] [ component ] layout.</p><p><strong>Layout-dependent algorithm:</strong></p><pre class="m-code"><span class="c1">//! Advance particles</span>
<span class="kt">void</span> <span class="nf">advance</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">dt</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
  <span class="c1">// Get access to particle scalars</span>
  <span class="n">tk</span><span class="o">::</span><span class="n">real</span><span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m_particles</span><span class="p">.</span><span class="n">ptr</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">m_nprop</span> <span class="o">+</span> <span class="n">m_offset</span><span class="p">;</span>
  
  <span class="c1">// Compute Nth scalar</span>
  <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">yn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">m_ncomp</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">yn</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  
  <span class="c1">// Generate Gaussian random numbers with zero mean and unit variance</span>
  <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">dW</span><span class="p">[</span><span class="n">m_ncomp</span><span class="p">];</span>
  <span class="n">m_rng</span><span class="o">-&gt;</span><span class="n">gaussian</span><span class="p">(</span> <span class="n">tid</span><span class="p">,</span> <span class="n">m_ncomp</span><span class="p">,</span> <span class="n">dW</span> <span class="p">);</span>
  
  <span class="c1">// Advance first m_ncomp (K=N-1) scalars</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">m_ncomp</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">d</span> <span class="o">=</span> <span class="n">m_k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">yn</span><span class="o">*</span><span class="n">dt</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">);</span> <span class="k">else</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">m_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">m_S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">yn</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">m_S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">d</span><span class="o">*</span><span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></pre></section><section id="layout_par"><h3><a href="#layout_par">Par - Access via particle-major layout policy</a></h3><p>This algorithm accesses particle data via the wrapper class, <code class="m-code"><span class="n">tk</span><span class="o">::</span><span class="n">Data</span></code>, in a data-layout-agnostic fashion. Access itself via this class is demonstrably &quot;zero-cost&quot;, i.e., an optimizing compiler completely optimizes the abstraction away: see <a href="layout.html#layout_asm" class="m-dox">Data layout implementation and assembly</a> for the assembly generated by 3 compilers. However, writing an SDE-advance algorithm in a data-layout-agnostic manner, requires index calculations at every particle-access compared to working with raw pointers, as described above. Thus the following tests are designed to measure only the additional index calculations that the layout-agnostic access entails.</p><p><strong>Layout-independent algorithm:</strong></p><pre class="m-code"><span class="c1">//! Advance particles</span>
<span class="kt">void</span> <span class="nf">advance</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">dt</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
  <span class="c1">// Compute Nth scalar</span>
  <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">yn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">m_particles</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">m_ncomp</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">yn</span> <span class="o">-=</span> <span class="n">m_particles</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">);</span>

  <span class="c1">// Generate Gaussian random numbers with zero mean and unit variance</span>
  <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">dW</span><span class="p">[</span><span class="n">m_ncomp</span><span class="p">];</span>
  <span class="n">m_rng</span><span class="o">-&gt;</span><span class="n">gaussian</span><span class="p">(</span> <span class="n">tid</span><span class="p">,</span> <span class="n">m_ncomp</span><span class="p">,</span> <span class="n">dW</span> <span class="p">);</span>

  <span class="c1">// Advance first m_ncomp (K=N-1) scalars</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">m_ncomp</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="n">d</span> <span class="o">=</span> <span class="n">m_k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_particles</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">yn</span> <span class="o">*</span> <span class="n">dt</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">);</span> <span class="k">else</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">m_particles</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">)</span> <span class="o">+=</span>
      <span class="mf">0.5</span><span class="o">*</span><span class="n">m_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">m_S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">yn</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">m_S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">m_particles</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dt</span>
      <span class="o">+</span> <span class="n">d</span><span class="o">*</span><span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></pre></section><section id="layout_comparison"><h3><a href="#layout_comparison">Comparison of the algorithms</a></h3><p><code class="m-code"><span class="err">DEBUG</span></code> mode uses <code class="m-code">-O0</code> and does not optimize function calls away for all of three compilers tested. <code class="m-code"><span class="err">RELEASE</span></code> mode uses <code class="m-code">-O3</code> and the abstraction is completely optimized away. However, index calculations still remain compared to a layout-dependent advance algorithm.</p><p>Total time measured in micro-seconds, run on a Lenovo laptop with Intel Core i7, 8 compute cores:</p><table class="m-table"><thead><tr><th>Run</th><th>Ptr</th><th>Par</th><th>Par/Ptr</th></tr></thead><tbody><tr><td>clang/DEBUG</td><td>150350236</td><td>338851735</td><td>2.2537 x slowdown</td></tr><tr><td>clang/RELEASE</td><td>98157742</td><td>104077139</td><td>1.0603 x slowdown</td></tr><tr><td>DEBUG/RELEASE</td><td>1.5317 x speedup</td><td>3.2558 x speedup</td><td>n/a</td></tr></tbody></table><table class="m-table"><thead><tr><th>Run</th><th>Ptr</th><th>Par</th><th>Par/Ptr</th></tr></thead><tbody><tr><td>gnu/DEBUG</td><td>161603164</td><td>386646353</td><td>2.3926 x slowdown</td></tr><tr><td>gnu/RELEASE</td><td>94747953</td><td>98187568</td><td>1.0363 x slowdown</td></tr><tr><td>DEBUG/RELEASE</td><td>1.7056 x speedup</td><td>3.9378 x speedup</td><td>n/a</td></tr></tbody></table><table class="m-table"><thead><tr><th>Run</th><th>Ptr</th><th>Par</th><th>Par/Ptr</th></tr></thead><tbody><tr><td>intel/DEBUG</td><td>171691440</td><td>608407412</td><td>3.5436 x slowdown</td></tr><tr><td>intel/RELEASE</td><td>90059133</td><td>89892665</td><td>0.99815 x speedup</td></tr><tr><td>DEBUG/RELEASE</td><td>1.9064 x speedup</td><td>6.7682 x speedup</td><td>n/a</td></tr></tbody></table></section><section id="layout_asm_discussion"><h3><a href="#layout_asm_discussion">Data layout benchmark discussion</a></h3><ul><li>As expected, inlining has a significant effect on performance: going from <code class="m-code"><span class="err">DEBUG</span></code> to <code class="m-code"><span class="err">RELEASE</span></code> mode yields a significant speedup with all three compilers, see last, <code class="m-code"><span class="err">DEBUGcode{.cmake}RELEASE</span></code>, rows.</li><li>As expected, the additional index calculations required by layout-agnostic access do take a performance hit: though only 6% with clang, and 3% with gnu, see last, <em>Par/Ptr</em>, columns.</li><li>Surprisingly, the layout-agnostic access is even a tiny bit faster than the layout-dependent algorithm with the Intel compiler with <code class="m-code">-O3</code>.</li></ul></section></section><section id="layout_conclusion"><h2><a href="#layout_conclusion">Conclusion</a></h2><p>As the implementation is not a significant performance hit, the equation advancement algorithms and particle-, and mesh-property data access are used only via the data-layout-independent interface. The data layout can be changed at compile time. Data access is abstracted (and optimized) away.</p><p>Note that the above discussion is independent of whether a particle-code or a mesh-code is used. From the data layout viewpoint the particle-major and mesh-field-major are equivalent and in the code, and in <a href="classtk_1_1_data.html" class="m-dox">tk::<wbr />Data</a>, this is called the <em>unknown</em>-major. See <a href="https://github.com/quinoacomputing/quinoa/blob/master/src/Base/Data.h">src/<wbr />Base/<wbr />Data.h</a> and its specializations in <a href="https://github.com/quinoacomputing/quinoa/blob/master/src/Base/Fields.h">src/<wbr />Base/<wbr />Fields.h</a> and <a href="https://github.com/quinoacomputing/quinoa/blob/master/src/Base/Particles.h">src/<wbr />Base/<wbr />Particles.h</a>. The data layouts for mesh-fields and particles can be configured independently at compile time via cmake variables <code class="m-code"><span class="err">PARTICLE_DATA_LAYOUT</span></code> and <code class="m-code"><span class="err">FIELD_DATA_LAYOUT</span></code>, see also <a href="https://github.com/quinoacomputing/quinoa/blob/master/cmake/ConfigureDataLayout.cmake">cmake/<wbr />ConfigureDataLayout.cmake</a>.</p><p>For the API, see <a href="classtk_1_1_data.html" class="m-dox">tk::<wbr />Data</a>, and for the full (and current) implementation, see <a href="https://github.com/quinoacomputing/quinoa/blob/master/src/Base/Data.h">src/<wbr />Base/<wbr />Data.h</a>.</p></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-dox-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-dox-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-dox-search-content">
          <input type="search" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" />
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript. Enable it or <a href="https://google.com/search?q=site:quinoacomputing.org/quinoa.github.io+">use an external search engine</a>.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            Search for symbols, directories, files, pages or modules. You can omit any
            prefix from the symbol or file path; adding a <code>:</code> or <code>/</code>
            suffix lists all members of given symbol or directory. Navigate through the
            list using <span class="m-label m-dim">&darr;</span> and
            <span class="m-label m-dim">&uarr;</span>, press
            <span class="m-label m-dim">Enter</span> to go.
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.<br />Maybe try a full-text <a href="#" id="search-external" data-search-engine="https://google.com/search?q=site:quinoacomputing.org/quinoa.github.io+{query}">search with external engine</a>?</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search.js"></script>
<script src="searchdata.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Quinoa docs, part of the <a href="http://quinoacomputing.org/quinoa.github.io/">Quinoa project</a>. Copyright © J. Bakosi 2012&ndash;2015, Los Alamos National Security, LLC, 2016&ndash;2018, <a href="https://www.triadns.org/">Triad National Security, LLC,</a> 2019-2021. Generated on Tuesday, Nov 23, 2021 based on <a href="https://github.com/quinoacomputing/quinoa/commit/167092848">167092848</a> by <a href="http://doxygen.org/">Doxygen</a> and <a href="http://mcss.mosra.cz/">m.css</a>. Contact us via <a href="https://github.com/quinoacomputing/quinoa/">GitHub</a>, <a href="https://groups.io/g/quinoa">Email</a> or <a href="https://quinoa.zulipchat.com">Chat</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>