<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>src/Inciter/Scheme.h file | Quinoa docs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="quinoa.m-dark-noindent+doxygen.compiled.css" />
  <link rel="icon" href="quinoa_sum.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">Quinoa <span class="m-thin">docs</span></a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="pages.html">Pages</a></li>
            <li><a href="namespaces.html">Namespaces</a></li>
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="5">
            <li>
              <a href="https://github.com/quinoacomputing/quinoa">GitHub</a>
              <ol>
                <li><a href="papers.html">Papers</a></li>
                <li><a href="coverage.html">Coverage</a></li>
                <li><a href="https://hub.docker.com/r/quinoacomputing/quinoa">Docker</a></li>
                <li><a href="https://travis-ci.org/quinoacomputing/quinoa/builds">Travis</a></li>
              </ol>
            </li>
            <li class="m-show-m"><a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          <span class="m-breadcrumb"><a href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a>/</span><span class="m-breadcrumb"><a href="dir_606df7a4664720c111e6e5b0e11c4e03.html">Inciter</a>/</span>Scheme.h <span class="m-thin">file</span>
        </h1>
        <p>Generic forwarding interface to discretization proxies.</p>
        <div class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li>
              Reference
              <ul>
                <li><a href="#namespaces">Namespaces</a></li>
                <li><a href="#nested-classes">Classes</a></li>
              </ul>
            </li>
          </ul>
        </div>
<aside class="m-note m-default"><h4>Copyright</h4><p>2012-2015, J. Bakosi, 2016-2018, Los Alamos National Security, LLC.</p></aside><p>This file defines a generic interface to discretization proxies.</p><p>The purpose of this class is to hide, behind a single type, different Charm++ proxy types that model a single concept, i.e., define some common functions as Charm++ entry methods that can be used in either a broadcast and/or in a way of addressing a single array element. As a result, member functions can be invoked by client code without knowing the underlying type or any specifics to the underlying differences of the classes that model the same concept, i.e., expose the same member functions. The idea is very similar to inheritance and runtime polymorphism with base classes and virtual functions: some member functions and data are common to all types modeled (and thus are not repeated and/or copied), while some are specific. A difference is that the &quot;base&quot; and &quot;child&quot; classes are Charm++ proxies. Note that while Charm++ does support inheritance and runtime polymorphism with chare arrays, we still prefer the implementation below because it uses entirely value semantics (inside and in client code) and thus it keeps the complexity of the dispatch behind this class and does not expose it client code.</p><p>The advantages of this class over traditional runtime polymorphism are (1) value semantics (both internally and to client code), (2) not templated, and (3) PUPable, i.e., an instance of Scheme can be sent across the network using Charm++&#x27;s pup framework. Also, since the class only holds a couple of chare proxies, it is extremely lightweight.</p><p>Example usage from client code:</p><pre class="m-code"><span class="c1">// Instantiate a Scheme object</span>
<span class="n">Scheme</span> <span class="nf">s</span><span class="p">(</span> <span class="n">ctr</span><span class="o">::</span><span class="n">SchemeType</span><span class="o">::</span><span class="n">DG</span> <span class="p">);</span>  <span class="c1">// see Control/Inciter/Options/Scheme.h</span>

<span class="c1">// Call a member function entry method in broadcast fashion</span>
<span class="n">s</span><span class="p">.</span><span class="n">coord</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">bcast</span> <span class="o">&gt;</span><span class="p">(</span> <span class="p">...</span> <span class="p">);</span>     <span class="c1">// equivalent to proxy.coord( ... );</span>

<span class="c1">// Call a member function entry method in addressing a single array</span>
<span class="c1">// element</span>
<span class="n">s</span><span class="p">.</span><span class="n">coord</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">elem</span> <span class="o">&gt;</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>   <span class="c1">// equivalent to proxy[0].coord( ... );</span>

<span class="c1">// Broadcast to a member function with optinoal CkEntryOptions object</span>
<span class="n">CkEntryOptions</span> <span class="n">opt</span><span class="p">;</span>
<span class="n">s</span><span class="p">.</span><span class="n">coord</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">bcast</span> <span class="o">&gt;</span><span class="p">(</span> <span class="p">...,</span> <span class="n">opt</span> <span class="p">);</span>     <span class="c1">// proxy.coord( ..., opt );</span>

<span class="c1">// Address array element with optinoal CkEntryOptions object</span>
<span class="n">s</span><span class="p">.</span><span class="n">coord</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">elem</span> <span class="o">&gt;</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">...,</span> <span class="n">opt</span> <span class="p">);</span>   <span class="c1">// proxy[0].coord( ..., opt );</span></pre><p>Organization, implementation details, end extension of the class:</p><p>Scheme, via inheriting from SchemeBase, contains two Charm++ proxies: discproxy and proxy. The former contains data and functionality common to all discretizations, and this can be considered as an equivalent to a base class in the OOP sense. The latter, proxy, contains data and functionality specific to a particular discretization. When instantiated, Scheme is configured for a single specific discretization which must be selected from the list of types in SchemeBase::Proxy.</p><p>The underlying type of proxy is a variant, which allows storing exactly one object. A variant is a type-safe union. An instance of a variant at any given time either holds a value of one of its alternative types. Read more on std::variant or boost::variant on how they work.</p><p>All new member functions that comprise of the concept of the underlying proxies, i.e., the interface, must be defined in Scheme. Whereas common data, functionality, as well as the list of the proxy types that can be configured are defined in SchemeBase. Adding a new forwarding function either as a broadcast or addressing a particular chare array element can be done by simply copying an existing (similar) one and modifying what underlying function (entry method) it calls. The ones that forward to discproxy are grouped first, while the ones that forward to the specific proxy are listed as second. Using SFINAE, multiple overloads are (and can be) defined for a single function, depending on (1) whether it is a broadcast or addressing an array element, (2) whether it takes an optional (default) last argument, usually used for passing a CkEntryOptions object. You can see the Charm++-generated .decl.h file to see what (if any) default arguments a particular entry method may take.</p><p>Currently, forwarding functions are defined for two types entry method calls: broadcasts, i.e., proxy.fn(), and addressing a particular element, i.e., proxy[x].fn(). Another third might be useful to add in the future and that is addressing an entry method behind a section proxy. As we have not used section proxies so far, this is not yet implemented, but if necessary, it should be relatively straightforward to do.</p><p>Extending this class to other discretization schemes is done entirely in SchemeBase. Adding a new discretization scheme amounts to, at the minimum: (1) Adding a new type of Charm++ chare array proxy to SchemeBase::Proxy, (2) Adding a new type of Charm++ chare array element proxy to SchemeBase::ProxyElem, and (3) Adding a new branch to the if test in SchemeBase&#x27;s constructor.</p><p>Implementation details: All forwarding calls are implemented taking a variadic parameter pack, which can take any number of arguments (including zero) and use perfect forwarding to pass the arguments to the entry method calls. This way the code remains generic, easy to modify, and the compiler automatically adjusts the generated forwarding calls if the types and/or number of the arguments to any of the entry methods change. One exception to this is those forwarding calls that deal with default arguments, allowing for passing CkEntryOptions objects. There the number of arguments are hard-coded in the SFINAE construct, but should also be straightforward to modify if necessary.</p><p>The functors named as call_* are used to dispatch (at compile time) entry method calls behind proxy, whose type is different depending on what specific discretization type is configured in the constructor. All common functionality in the call_* functors are lifted over to SchemeBase::Call. This helps keeping the function-call-specific code in Scheme minimal and reuses the generic part in SchemeBase.</p><p>Note that another way of doing the dispatch, that is now done using the call_* functors, could have been implemented using a (compile-, or runtime) associative container storing std::function objects which would store pre-bound function arguments. That would work, but there are three problems with such an approach: (1) std::function is not obvious how to pup, i.e., send across the network, (2) std::bind cannot currently be used to bind a variadic number arguments and thus the bind calls would not be very generic, and (3) a runtime associative container would take additional state.</p><aside class="m-note m-default"><h4>See also</h4><p>Talk on <a href="http://charm.cs.illinois.edu/charmWorkshop/slides/CharmWorkshop2018_bakosi.pdf">Concept-based runtime polymorphism with Charm++ chare arrays using value semantics</a> at the 16th Annual Workshop on Charm++ and its Applications, April 2018.</p></aside>
        <section id="namespaces">
          <h2><a href="#namespaces">Namespaces</a></h2>
          <dl class="m-dox">
            <dt>namespace <a href="namespaceinciter.html" class="m-dox">inciter</a></dt>
            <dd>Inciter declarations and definitions.</dd>
          </dl>
        </section>
        <section id="nested-classes">
          <h2><a href="#nested-classes">Classes</a></h2>
          <dl class="m-dox">
            <dt>
              class <a href="classinciter_1_1_scheme.html" class="m-dox">inciter::Scheme</a>
            </dt>
            <dd>Generic forwarding interface to discretization proxies.</dd>
          </dl>
        </section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-dox-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-dox-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-dox-search-content">
          <input type="search" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" />
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript. Enable it or <a href="https://google.com/search?q=site:quinoacomputing.org+">use an external search engine</a>.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            Search for symbols, directories, files, pages or modules. You can omit any
            prefix from the symbol or file path; adding a <code>:</code> or <code>/</code>
            suffix lists all members of given symbol or directory. Navigate through the
            list using <span class="m-label m-dim">&darr;</span> and
            <span class="m-label m-dim">&uarr;</span>, press
            <span class="m-label m-dim">Enter</span> to go.
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.<br />Maybe try a full-text <a href="#" id="search-external" data-search-engine="https://google.com/search?q=site:quinoacomputing.org+{query}">search with external engine</a>?</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search.js"></script>
<script src="searchdata.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Quinoa docs, part of the <a href="http://quinoacomputing.org/">Quinoa project</a>. Copyright © J. Bakosi 2012&ndash;2015, <a href="http://www.lansllc.com/">Los Alamos National Security, LLC,</a> 2016&ndash;2018.<br />Generated on Tuesday, Nov 13, 2018 based on <a href="https://github.com/quinoacomputing/quinoa/commit/e7a43de">e7a43de</a> by <a href="http://doxygen.org/">Doxygen</a> 1.8.15 and <a href="http://mcss.mosra.cz/">m.css</a>. Contact us via <a href="https://github.com/quinoacomputing/quinoa/">GitHub</a>, <a href="mailto:quinoa@lanl.gov">Email</a> or <a href="https://gitter.im/quinoacomputing/quinoa">Gitter</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>